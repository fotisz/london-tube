<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style type="text/css">
@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}
body {
-webkit-text-size-adjust: 100%;
text-size-adjust: 100%;
color: #333;
font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.6;
word-wrap: break-word;
}
a {
background-color: transparent;
}
a:active,
a:hover {
outline: 0;
}
strong {
font-weight: bold;
}
h1 {
font-size: 2em;
margin: 0.67em 0;
}
img {
border: 0;
}
hr {
box-sizing: content-box;
height: 0;
}
pre {
overflow: auto;
}
code,
kbd,
pre {
font-family: monospace, monospace;
font-size: 1em;
}
input {
color: inherit;
font: inherit;
margin: 0;
}
html input[disabled] {
cursor: default;
}
input {
line-height: normal;
}
input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
table {
border-collapse: collapse;
border-spacing: 0;
}
td,
th {
padding: 0;
}
* {
box-sizing: border-box;
}
input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a {
color: #4078c0;
text-decoration: none;
}
a:hover,
a:active {
text-decoration: underline;
}
hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
hr:before {
display: table;
content: "";
}
hr:after {
display: table;
clear: both;
content: "";
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
h1 {
font-size: 30px;
}
h2 {
font-size: 21px;
}
h3 {
font-size: 16px;
}
h4 {
font-size: 14px;
}
h5 {
font-size: 12px;
}
h6 {
font-size: 11px;
}
blockquote {
margin: 0;
}
ul,
ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
ol ol,
ul ol {
list-style-type: lower-roman;
}
ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
list-style-type: lower-alpha;
}
dd {
margin-left: 0;
}
code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.select::-ms-expand {
opacity: 0;
}
.octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
a:not([href]) {
color: inherit;
text-decoration: none;
}
.anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.anchor:focus {
outline: none;
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
text-decoration: none;
}
h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
visibility: visible;
}
h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
h1 .anchor {
line-height: 1;
}
h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
h2 .anchor {
line-height: 1;
}
h3 {
font-size: 1.5em;
line-height: 1.43;
}
h3 .anchor {
line-height: 1.2;
}
h4 {
font-size: 1.25em;
}
h4 .anchor {
line-height: 1.2;
}
h5 {
font-size: 1em;
}
h5 .anchor {
line-height: 1.1;
}
h6 {
font-size: 1em;
color: #777;
}
h6 .anchor {
line-height: 1.1;
}
p,
blockquote,
ul,
ol,
dl,
table,
pre {
margin-top: 0;
margin-bottom: 16px;
}
hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
ul,
ol {
padding-left: 2em;
}
ul ul,
ul ol,
ol ol,
ol ul {
margin-top: 0;
margin-bottom: 0;
}
li>p {
margin-top: 16px;
}
dl {
padding: 0;
}
dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
blockquote>:first-child {
margin-top: 0;
}
blockquote>:last-child {
margin-bottom: 0;
}
table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
table th {
font-weight: bold;
}
table th,
table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
table tr:nth-child(2n) {
background-color: #f8f8f8;
}
img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
code:before,
code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.highlight {
margin-bottom: 16px;
}
.highlight pre,
pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.highlight pre {
margin-bottom: 0;
word-break: normal;
}
pre {
word-wrap: normal;
}
pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
pre code:before,
pre code:after {
content: normal;
}
kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.pl-c {
color: #969896;
}
.pl-c1,
.pl-s .pl-v {
color: #0086b3;
}
.pl-e,
.pl-en {
color: #795da3;
}
.pl-s .pl-s1,
.pl-smi {
color: #333;
}
.pl-ent {
color: #63a35c;
}
.pl-k {
color: #a71d5d;
}
.pl-pds,
.pl-s,
.pl-s .pl-pse .pl-s1,
.pl-sr,
.pl-sr .pl-cce,
.pl-sr .pl-sra,
.pl-sr .pl-sre {
color: #183691;
}
.pl-v {
color: #ed6a43;
}
.pl-id {
color: #b52a1d;
}
.pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.pl-ml {
color: #693a17;
}
.pl-mh,
.pl-mh .pl-en,
.pl-ms {
color: #1d3e81;
font-weight: bold;
}
.pl-mq {
color: #008080;
}
.pl-mi {
color: #333;
font-style: italic;
}
.pl-mb {
color: #333;
font-weight: bold;
}
.pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.pl-mdr {
color: #795da3;
font-weight: bold;
}
.pl-mo {
color: #1d3e81;
}
kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.task-list-item {
list-style-type: none;
}
.task-list-item+.task-list-item {
margin-top: 3px;
}
.task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
:checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
.sourceLine {
display: inline-block;
}
code .kw { color: #000000; }
code .dt { color: #ed6a43; }
code .dv { color: #009999; }
code .bn { color: #009999; }
code .fl { color: #009999; }
code .ch { color: #009999; }
code .st { color: #183691; }
code .co { color: #969896; }
code .ot { color: #0086b3; }
code .al { color: #a61717; }
code .fu { color: #63a35c; }
code .er { color: #a61717; background-color: #e3d2d2; }
code .wa { color: #000000; }
code .cn { color: #008080; }
code .sc { color: #008080; }
code .vs { color: #183691; }
code .ss { color: #183691; }
code .im { color: #000000; }
code .va {color: #008080; }
code .cf { color: #000000; }
code .op { color: #000000; }
code .bu { color: #000000; }
code .ex { color: #000000; }
code .pp { color: #999999; }
code .at { color: #008080; }
code .do { color: #969896; }
code .an { color: #008080; }
code .cv { color: #008080; }
code .in { color: #008080; }
</style>
<style>
body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
  padding-top: 0px;
}
</style>

</head>

<body>

<h1 id="part-one-managing-data">Part One: Managing Data</h1>
<h1 id="introduction">Introduction</h1>
<p>This notebook forms the first of two outputs in the analysis of the TfL London Tube network and is primarily concerned with the transformation and manipulation of the required datasets in comparison to Part Two which focusses on visualisation.</p>
<h1 id="apis-and-internet-data">APIs and Internet Data</h1>
<p>The dataset being explored is a live feed of the Transport for London network timetables. As described on the TfL website:</p>
<blockquote>
<p>The Journey Planner timetable feed contains up-to-date standard timetables for London Underground, bus, DLR, TfL Rail and river services. The timetables are updated every seven days.</p>
</blockquote>
<p>The dataset is freely available and is bound by the <a href="https://tfl.gov.uk/corporate/terms-and-conditions/transport-data-service">TfL Open Data License</a>. To access it, download the zip file at the link below</p>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><div class="sourceLine" id="cb1-1" data-line-number="1">root.dir &lt;-<span class="st"> </span>rprojroot<span class="op">::</span><span class="kw">find_rstudio_root_file</span>()</div>
<div class="sourceLine" id="cb1-2" data-line-number="2">data.dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(root.dir, <span class="st">&quot;1_data/1_1_raw_data&quot;</span>) <span class="co"># Where we want the files to end up</span></div></code></pre>
<pre class="sourceCode r" id="cb2"><code class="sourceCode r"><div class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&quot;tfl-developer-passwords.R&quot;</span>) <span class="co"># load app_id and app_key</span></div>
<div class="sourceLine" id="cb2-2" data-line-number="2">dataset_url &lt;-<span class="st"> &quot;http://data.tfl.gov.uk/tfl/syndication/feeds/journey-planner-timetables.zip&quot;</span></div>
<div class="sourceLine" id="cb2-3" data-line-number="3">dataset_url &lt;-<span class="st"> </span><span class="kw">paste0</span>(dataset_url, <span class="st">&quot;?app_id=&quot;</span>, app_id, <span class="st">&quot;&amp;app_key=&quot;</span>, app_key)</div>
<div class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">download.file</span>(dataset_url, <span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables.zip&quot;</span>))</div></code></pre>
<p><em>Note: You may need to <a href="https://api-portal.tfl.gov.uk/">register</a> for an API key to access the zip file. In the event that you cannot gain access there is a small demo sample <a href="https://tfl.gov.uk/cdn/static/cms/documents/journey-planner-timetables.zip">here</a></em></p>
<p>Unpack the download once to split out the train/ferry timetables from the bus timetables and again to unpack the tube/DLR timetables.</p>
<pre class="sourceCode r" id="cb3"><code class="sourceCode r"><div class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">unzip</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables.zip&quot;</span>), <span class="dt">exdir =</span> <span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables&quot;</span>))</div>
<div class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">unzip</span>(<span class="kw">list.files</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables&quot;</span>), <span class="dt">pattern =</span> <span class="st">&quot;LULDLR&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>),</div>
<div class="sourceLine" id="cb3-3" data-line-number="3">      <span class="dt">exdir =</span> <span class="kw">file.path</span>(data.dir, <span class="st">&quot;/timetables/data&quot;</span>))</div></code></pre>
<pre class="sourceCode r" id="cb4"><code class="sourceCode r"><div class="sourceLine" id="cb4-1" data-line-number="1">data.files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;/timetables/data&quot;</span>),</div>
<div class="sourceLine" id="cb4-2" data-line-number="2">                         <span class="dt">pattern =</span> <span class="st">&quot;tfl_1-[^.]+</span><span class="ch">\\</span><span class="st">.xml&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</div>
<div class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">print</span>(<span class="kw">head</span>(<span class="kw">basename</span>(data.files)))</div></code></pre>
<p>The result is 600-800MB of XML files containing the most up-to-date timetable information for the London Underground and DLR services. The pattern of London Underground files we require are XML files that start with “tfl_1” as the files with other prefixes are ferry, DLR or TfL rail timetables.</p>
<h1 id="data-exploration-and-transformation">Data Exploration and Transformation</h1>
<p>For this section, we’ll investigate the structure of the API feed, ways to extract the important data, manipulate it into the required shape and add any necessary calculations. This will be demonstrated for one of the XML files in a manner which can be generalised for any other timetable.</p>
<h2 id="initial-exploration">Initial Exploration</h2>
<p>Begin by reading in the first XML file.</p>
<pre class="sourceCode r" id="cb5"><code class="sourceCode r"><div class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(magrittr)</div>
<div class="sourceLine" id="cb5-2" data-line-number="2">doc &lt;-<span class="st"> </span>data.files[<span class="dv">1</span>] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">read_xml</span>()</div>
<div class="sourceLine" id="cb5-4" data-line-number="4">doc</div></code></pre>
<p>This metadata contains two important pieces of information.</p>
<p>Firstly, the top level node contains <em>eight</em> distinct child nodes. As it turns out these are all disparate datasets which all relate to this particular file.</p>
<ul>
<li>The <em>StopPoints</em> provide the stop locations which group up to a given stop “locality” in <em>NptgLocalities</em>.</li>
<li>The <em>Routes</em> are broken down into <em>RouteSections</em> and <em>JourneyPatternSections</em></li>
<li>The <em>Operator</em> is pretty useless as this is always “LUL” for tube data</li>
<li>The <em>Service</em> is how the file derives its name so there’s one in each XML file</li>
<li>Finally the <em>VehicleJourney</em> is the most granular level of information as it provides the exact trip link of a vehicle moving from one station to the next in a given <em>JourneyPatternSection</em></li>
</ul>
<p>Secondly, the namespace of the XML file is non-standard. This suggests that the XML structure adheres to the <em>TransXChange</em> schema provided by the UK Department of Transport for any timetable data. We can configure this namespace for use with any future XPaths (the alternative is to simply strip it entirely from the file however this takes additional processing time).</p>
<pre class="sourceCode r" id="cb6"><code class="sourceCode r"><div class="sourceLine" id="cb6-1" data-line-number="1">namespace &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">txc =</span> <span class="st">&quot;http://www.transxchange.org.uk/&quot;</span>)</div></code></pre>
<p>Once we set up an extraction procedure for this schema it can then be applied to any future DoT standard timetable.</p>
<p>To quickly get an idea of the structure we can traverse the document as a list:</p>
<pre class="sourceCode r" id="cb7"><code class="sourceCode r"><div class="sourceLine" id="cb7-1" data-line-number="1">xml_list &lt;-<span class="st"> </span>doc <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># we can also vary the depth</span></div>
<div class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">as_list</span>()</div></code></pre>
<p>and inspect the structure of each node underneath</p>
<pre class="sourceCode r" id="cb8"><code class="sourceCode r"><div class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>NptgLocalities<span class="op">$</span>AnnotatedNptgLocalityRef)</div>
<div class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">str</span>(xml_list<span class="op">$</span>StopPoints<span class="op">$</span>StopPoint)</div>
<div class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">str</span>(xml_list<span class="op">$</span>RouteSections<span class="op">$</span>RouteSection[[<span class="dv">1</span>]])</div>
<div class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">str</span>(xml_list<span class="op">$</span>Routes<span class="op">$</span>Route)</div>
<div class="sourceLine" id="cb8-5" data-line-number="5"><span class="kw">str</span>(xml_list<span class="op">$</span>JourneyPatternSections<span class="op">$</span>JourneyPatternSection[[<span class="dv">1</span>]])</div>
<div class="sourceLine" id="cb8-6" data-line-number="6"><span class="kw">str</span>(xml_list<span class="op">$</span>Operators<span class="op">$</span>Operator)</div>
<div class="sourceLine" id="cb8-7" data-line-number="7"><span class="kw">str</span>(xml_list<span class="op">$</span>Services<span class="op">$</span>Service<span class="op">$</span>StandardService<span class="op">$</span>JourneyPattern)</div>
<div class="sourceLine" id="cb8-8" data-line-number="8"><span class="kw">str</span>(xml_list<span class="op">$</span>VehicleJourneys<span class="op">$</span>VehicleJourney)</div>
<div class="sourceLine" id="cb8-9" data-line-number="9"></div>
<div class="sourceLine" id="cb8-10" data-line-number="10"><span class="co"># Show service data without the child node JourneyPatterns</span></div>
<div class="sourceLine" id="cb8-11" data-line-number="11">service &lt;-<span class="st"> </span>xml_list<span class="op">$</span>Services<span class="op">$</span>Service</div>
<div class="sourceLine" id="cb8-12" data-line-number="12">service<span class="op">$</span>StandardService &lt;-<span class="st"> </span><span class="ot">NULL</span></div>
<div class="sourceLine" id="cb8-13" data-line-number="13"><span class="kw">str</span>(service)</div></code></pre>
<p>There is clearly a huge amount of information here. Four of the tables contain crucial information other than Reference fields and linking identifiers:</p>
<p><strong>Stop Points</strong></p>
<ul>
<li>AtcoCode as a unique identifier of the stop across the network. There is one for the inbound trains and a second identifier for the same stop going the other way. These group up into Localities (under the Place node)</li>
<li>CommonName for the stop’s name</li>
<li>Location for its Easting and Northing coordinates</li>
</ul>
<p><strong>Journey Pattern Sections</strong></p>
<ul>
<li>From and To fields show every possible trip link between two stations</li>
<li>WaitTime is encoded in “PT1M” (assumed to be 1 minute of waiting) and is not applicable to each trip link (therefore the tag often disappears!)</li>
<li>RunTime is also encoded and provides the time taken for a trip link</li>
</ul>
<p><strong>Services</strong></p>
<ul>
<li>LineName though this is fairly obvious from the file name</li>
<li>Operating Period as this tells us which period of time the timetable is actually active for. This particular timetable is only in effect on Christmas Eve.</li>
<li>Operating Profile says for which day(s) of the week and bank holidays the timetable is and isn’t operational. Again, these tags will vary in their structure from document to document making these fields quite difficult to parse.</li>
</ul>
<p><strong>VehicleJourneys</strong></p>
<ul>
<li>Operating Profile again as some journeys may only apply to some of the days that a service spans</li>
<li>Departure Time provides the train <em>origin</em> departure time. The difficult part is to now interpolate the departure time of <em>each station</em> along a journey using the RunTime and WaitTime in <strong>Journey Pattern Sections</strong>.</li>
</ul>
<p>It’s also worth noting that the StopPoints and NptgLocalities tables both contain dupliate information across every Service (XML file) for a given line and also contain duplicates <em>across</em> lines that share the same stops. Every other table has unique information per XML file because the routes, trip links, vehicles and journeys are all defined by Service. This would mean that the timetable for Christmas Day has a completely different set of trip links to that of Boxing Day despite the trains physically running on exactly the same routes. This clearly leads to a vast amount of redundant information which can be easily cut down by a factor of 10-40x by extracting a subset of interest.</p>
<h2 id="subsetting">Subsetting</h2>
<p>As seen in the previous section, that entire file was only relevant for one day of the year. By first filtering the files based on the Operating Period and Operating Profile, it’s possible to only read in the files that relate to a Monday or New Years Day or 17th January.</p>
<p>The bad news is that extracting out the nested Operating Profile information isn’t easy.</p>
<pre class="sourceCode r" id="cb9"><code class="sourceCode r"><div class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(data.table)</div>
<div class="sourceLine" id="cb9-2" data-line-number="2">xpath.op_period &lt;-<span class="st"> &quot;.//txc:Services/txc:Service/txc:OperatingPeriod/*&quot;</span></div>
<div class="sourceLine" id="cb9-3" data-line-number="3"></div>
<div class="sourceLine" id="cb9-4" data-line-number="4">dates &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.files, <span class="cf">function</span>(xml_file) {</div>
<div class="sourceLine" id="cb9-5" data-line-number="5">  XML<span class="op">::</span><span class="kw">xmlParse</span>(xml_file) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#xml2::read_xml is faster</span></div>
<div class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xmlRoot</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xpathApply</span>(xpath.op_period, <span class="dt">namespaces =</span> namespace, <span class="dt">fun =</span> <span class="cf">function</span>(y) XML<span class="op">::</span><span class="kw">xmlValue</span>(y) <span class="op">%&gt;%</span><span class="st"> </span>as.Date)</div>
<div class="sourceLine" id="cb9-8" data-line-number="8">}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb9-9" data-line-number="9">{<span class="kw">data.table</span>(<span class="kw">names</span>(.), <span class="kw">rbindlist</span>(.))}</div>
<div class="sourceLine" id="cb9-10" data-line-number="10"><span class="kw">names</span>(dates) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;File&quot;</span>, <span class="st">&quot;StartDate&quot;</span>, <span class="st">&quot;EndDate&quot;</span>)</div>
<div class="sourceLine" id="cb9-11" data-line-number="11">dates[[<span class="st">&quot;File&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">basename</span>(dates[[<span class="st">&quot;File&quot;</span>]])</div>
<div class="sourceLine" id="cb9-12" data-line-number="12"><span class="kw">head</span>(dates, <span class="dv">10</span>)</div></code></pre>
<p>The next step is to filter this dataframe based on whether a date of interest falls within the time interval of a file</p>
<pre class="sourceCode r" id="cb10"><code class="sourceCode r"><div class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">library</span>(lubridate)</div>
<div class="sourceLine" id="cb10-2" data-line-number="2">timetable_date &lt;-<span class="st"> </span>lubridate<span class="op">::</span><span class="kw">today</span>()</div>
<div class="sourceLine" id="cb10-3" data-line-number="3">relevant_dates &lt;-<span class="st"> </span>dates <span class="op">%$%</span></div>
<div class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="co"># Test whether the timetable_date falls within StartDate to EndDate</span></div>
<div class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  </span><span class="kw">interval</span>(StartDate, EndDate) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span>{timetable_date <span class="op">%within%</span><span class="st"> </span>.} <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  </span><span class="co"># Subset dates to only these records</span></div>
<div class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">  </span>dates[.]</div>
<div class="sourceLine" id="cb10-9" data-line-number="9"><span class="kw">head</span>(relevant_dates, <span class="dv">10</span>)</div></code></pre>
<p>Now we’ve cut down the 84 files to roughly a quarter of the number.</p>
<p>The other option (to filter based on the days of the week) is even more convoluted. It should be as simply as filtering on the tags underneath Journey Operating Profile however here’s a list of the unique set of tags</p>
<pre class="sourceCode r" id="cb11"><code class="sourceCode r"><div class="sourceLine" id="cb11-1" data-line-number="1">xpath.days_of_week &lt;-<span class="st"> &quot;.//txc:VehicleJourneys/txc:VehicleJourney/txc:OperatingProfile/txc:RegularDayType/txc:DaysOfWeek/*&quot;</span></div>
<div class="sourceLine" id="cb11-2" data-line-number="2">daysofweek &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.files, <span class="cf">function</span>(xml_file) {</div>
<div class="sourceLine" id="cb11-3" data-line-number="3">  XML<span class="op">::</span><span class="kw">xmlParse</span>(xml_file) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#xml2::read_xml is faster</span></div>
<div class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xmlRoot</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xpathApply</span>(xpath.days_of_week, <span class="dt">namespaces =</span> namespace, <span class="dt">fun =</span> XML<span class="op">::</span>xmlName)</div>
<div class="sourceLine" id="cb11-6" data-line-number="6">}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb11-7" data-line-number="7"><span class="st">  </span>unlist <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb11-8" data-line-number="8"><span class="st">  </span>unique</div>
<div class="sourceLine" id="cb11-9" data-line-number="9">daysofweek</div></code></pre>
<p>The “days of the week” also include values such as “MondayToFriday”, “Weekend” as well as “MondayToSaturday” and “MondayToSunday” under the Service Operating Profile. So we would need to create a mapping function between a given date and all of the possible “days of the week” it could fall under. This is accounted for [here] and [here] however won’t be covered in this notebook.</p>
<h2 id="extraction">Extraction</h2>
<p>Now that we have a good understanding of what each file contains, we can attempt to extract the key information from one of them before generalising this process for all files. As we’ve already seen, the tree structure of these XML files is particularly complex thereby making one-size-fits-all functions such as <code>xmlToDataFrame</code> rather unhelpful. The level of control required is really only achievable by defining XPaths for the location of each piece of information we need and then looping through the document extracting every instance of each path. On the plus side, the files are well-formed and do not contain any errors which we may find in malformed web data.</p>
<p>Firstly, we’ll want to retrieve the parent XPaths for each of the nodes containing useful information. This is done simplest with a helper function <code>xml_get_paths</code> from the <a href="https://github.com/dantonnoriega/xmltools">xmltools</a> library.</p>
<!-- 
The empty code chunks represent code that lives in external files.
If you wish to execute the chunks interactively, run the corresponding
`read_chunk` (see previous chunk) to source the code and execute it with
`eval(parse(text=knitr:::knit_code$get()$extraction_setup))`
 -->

<pre class="sourceCode r" id="cb12"><code class="sourceCode r"><div class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Get top level nodeset for first file</span></div>
<div class="sourceLine" id="cb12-2" data-line-number="2">doc &lt;-<span class="st"> </span>data.files[<span class="dv">1</span>] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">read_xml</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">xml_ns_strip</span>()</div>
<div class="sourceLine" id="cb12-5" data-line-number="5">nodeset &lt;-<span class="st"> </span>doc <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">xml_children</span>()</div>
<div class="sourceLine" id="cb12-7" data-line-number="7"></div>
<div class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># Get the xpaths to parents of a terminal node</span></div>
<div class="sourceLine" id="cb12-9" data-line-number="9">terminal_xpaths &lt;-<span class="st"> </span>nodeset <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span>xmltools<span class="op">::</span><span class="kw">xml_get_paths</span>(<span class="dt">only_terminal_parent =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">  </span><span class="co"># Filter to unique paths</span></div>
<div class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb12-13" data-line-number="13"><span class="st">  </span><span class="kw">unique</span>()</div></code></pre>
<pre class="sourceCode r" id="cb13"><code class="sourceCode r"><div class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">head</span>(terminal_xpaths)</div></code></pre>
<p>These are the XPaths to every possible branch of the tree however a lot of the information isn’t particularly useful. For some of the tables, we’re only interested in specific sections. For example, the <em>Operational</em> tag isn’t interesting as it contains information about the vehicle which in this case will always be “Underground Train”. This is a similar story for the <em>Operator</em> which is always “London Underground”.</p>
<p>Therefore we can define a subset of the XPaths grouped by the table to which they each relate.</p>
<pre class="sourceCode r" id="cb14"><code class="sourceCode r"><div class="sourceLine" id="cb14-1" data-line-number="1">required_xpaths &lt;-<span class="st"> </span><span class="kw">list</span>(</div>
<div class="sourceLine" id="cb14-2" data-line-number="2">   <span class="dt">NptgLocalities =</span> <span class="dv">1</span></div>
<div class="sourceLine" id="cb14-3" data-line-number="3">  ,<span class="dt">StopPoints =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">5</span></div>
<div class="sourceLine" id="cb14-4" data-line-number="4">  ,<span class="dt">RouteLinks =</span> <span class="dv">8</span><span class="op">:</span><span class="dv">10</span></div>
<div class="sourceLine" id="cb14-5" data-line-number="5">  ,<span class="dt">Routes =</span> <span class="dv">11</span></div>
<div class="sourceLine" id="cb14-6" data-line-number="6">  ,<span class="dt">JourneyPatternTimingLinks =</span> <span class="dv">12</span><span class="op">:</span><span class="dv">14</span></div>
<div class="sourceLine" id="cb14-7" data-line-number="7">  ,<span class="dt">Services =</span> <span class="dv">16</span></div>
<div class="sourceLine" id="cb14-8" data-line-number="8">  ,<span class="dt">JourneyPatterns =</span> <span class="dv">24</span></div>
<div class="sourceLine" id="cb14-9" data-line-number="9">  ,<span class="dt">VehicleJourneys =</span> <span class="dv">26</span></div>
<div class="sourceLine" id="cb14-10" data-line-number="10">)</div></code></pre>
<pre class="sourceCode r" id="cb15"><code class="sourceCode r"><div class="sourceLine" id="cb15-1" data-line-number="1">terminal_xpaths[<span class="kw">unlist</span>(required_xpaths)]</div></code></pre>
<p>This way, when it comes to extracting the data, all of the information found under the 8th, 9th and 10th Paths of <code>terminal_xpaths</code> will be combined together under the <em>RouteSections</em> table.</p>
<p>Now it is just a matter of looping over this list, finding all of the matches for each path, extracting the underlying data and combining it into a single dataset for each of the seven tables.</p>
<pre class="sourceCode r" id="cb16"><code class="sourceCode r"><div class="sourceLine" id="cb16-1" data-line-number="1">build_tfl &lt;-<span class="st"> </span><span class="cf">function</span>(doc, terminal_xpaths, required_terminal_xpaths) {</div>
<div class="sourceLine" id="cb16-2" data-line-number="2">  purrr<span class="op">::</span><span class="kw">map</span>(required_terminal_xpaths, <span class="cf">function</span>(xpath_idxs) {</div>
<div class="sourceLine" id="cb16-3" data-line-number="3">    <span class="co"># Subset the needed paths</span></div>
<div class="sourceLine" id="cb16-4" data-line-number="4">    terminal_xpaths[xpath_idxs] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb16-5" data-line-number="5"><span class="st">      </span><span class="co"># Find all matches of each path</span></div>
<div class="sourceLine" id="cb16-6" data-line-number="6"><span class="st">      </span><span class="kw">lapply</span>(xml2<span class="op">::</span>xml_find_all, <span class="dt">x =</span> doc) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">      </span><span class="co"># Extract underlying data</span></div>
<div class="sourceLine" id="cb16-8" data-line-number="8"><span class="st">      </span>purrr<span class="op">::</span><span class="kw">map</span>(xmltools<span class="op">::</span>xml_dig_df) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb16-9" data-line-number="9"><span class="st">      </span><span class="co"># Combine extracted data into one dataframe</span></div>
<div class="sourceLine" id="cb16-10" data-line-number="10"><span class="st">      </span>purrr<span class="op">::</span><span class="kw">map</span>(dplyr<span class="op">::</span>bind_rows) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">      </span>dplyr<span class="op">::</span><span class="kw">bind_cols</span>()</div>
<div class="sourceLine" id="cb16-12" data-line-number="12">  })</div>
<div class="sourceLine" id="cb16-13" data-line-number="13">}</div></code></pre>
<pre class="sourceCode r" id="cb17"><code class="sourceCode r"><div class="sourceLine" id="cb17-1" data-line-number="1">tfl &lt;-<span class="st"> </span><span class="kw">build_tfl</span>(doc, terminal_xpaths, required_xpaths)</div>
<div class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">str</span>(tfl, <span class="dv">1</span>)</div></code></pre>
<p>The result is the <code>tfl</code> list which contains the seven tables with any number of observations in each.</p>
<p>Due to the flexibility of XML however, there’s still a lot missing…</p>
<ol>
<li>A number of important fields are found in the “id” <em>attribute</em> of certain tags, not in the tag text as we might expect.</li>
<li>The stop sequence numbers are contained in a “SequenceNumber” attribute</li>
<li>Some tables have a parent which contains join information. For example, the JourneyPatterns table is defined at the level of each Journey Pattern Section however we are missing the Journey Pattern ID as this is the parent node of each Section and therefore unable to be parsed with the same XPath.</li>
</ol>
<p>We can define a function <code>retrieve_additional_fields</code> which solves these three cases and call it after <code>build_tfl</code> for each document. Due to its length and complexity it is not shown here but can be found in the complete analysis file.</p>
<pre class="sourceCode r" id="cb18"><code class="sourceCode r"><div class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">library</span>(magrittr)</div>
<div class="sourceLine" id="cb18-2" data-line-number="2">tfl <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">retrieve_additional_fields</span>(doc)</div></code></pre>
<p>We can put the whole extraction process together by calling <code>read_xml</code>, <code>build_tfl</code> and <code>retrieve_additional_fields</code> for each XML file:</p>
<pre class="sourceCode r" id="cb19"><code class="sourceCode r"><div class="sourceLine" id="cb19-1" data-line-number="1">extract_file &lt;-<span class="st"> </span><span class="cf">function</span>(file){</div>
<div class="sourceLine" id="cb19-2" data-line-number="2">  doc &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">read_xml</span>(file) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">    </span>xml2<span class="op">::</span><span class="kw">xml_ns_strip</span>()</div>
<div class="sourceLine" id="cb19-4" data-line-number="4">  </div>
<div class="sourceLine" id="cb19-5" data-line-number="5">  tfl &lt;-<span class="st"> </span><span class="kw">build_tfl</span>(doc, terminal_xpaths, required_xpaths)</div>
<div class="sourceLine" id="cb19-6" data-line-number="6">  tfl <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">retrieve_additional_fields</span>(doc)</div>
<div class="sourceLine" id="cb19-7" data-line-number="7">  </div>
<div class="sourceLine" id="cb19-8" data-line-number="8">  tfl</div>
<div class="sourceLine" id="cb19-9" data-line-number="9">}</div>
<div class="sourceLine" id="cb19-10" data-line-number="10"><span class="kw">str</span>(<span class="kw">extract_file</span>(data.files[<span class="dv">1</span>]), <span class="dv">1</span>)</div></code></pre>
<p>and then loop this function over the entire directory of files:</p>
<pre class="sourceCode r" id="cb20"><code class="sourceCode r"><div class="sourceLine" id="cb20-1" data-line-number="1">tfl_all &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(data.files, extract_file)</div></code></pre>
<p>Unfortunately, the bad news is this code chunk takes a <strong>very</strong> long time to run so don’t execute it unless you plan on waiting all night. Literally…</p>
<p>Despite a few good libraries, R is pretty shocking at XML scraping when compared to the <code>lxml</code> Python library. The versatility of <code>lxml</code> is also significantly better when it comes to traversing XML trees efficiently and extracting data in nested nodes, parent nodes and attributes as we require.</p>
<p>To cope with this problem, the dataset was instead scraped with even more fields in more awkward-to-reach places (and about 500x faster) with <a href="XMLParsing.html">this file</a>.</p>
<h2 id="variable-creation">Variable Creation</h2>
<p>There are a few crucial variables which we’ll need along with correct typecasting for any further analysis so we can create these in R before handing over to a database. Due to the potential scale of the join operations (had we not already subsetted the dataset), additional variables which are calculations <em>across</em> tables will be left to the database stage.</p>
<h3 id="latitude-and-longitude">Latitude and Longitude</h3>
<p>To make any use of the station locations, it’s necessary to convert the provided data to a more renowned coordinate system.</p>
<p>The <a href="http://naptan.dft.gov.uk/transxchange/technicalFaq.htm#PubCoords">TransXChange website</a> confirms that the “Easting” and “Northing” fields in the StopPoints dataset are British National Grid (BNG) coordinates whereas we require the more popular latitude and longitude.</p>
<p>This can be achieved with the R Geospatial Data Abstraction Library which is able to convert between the two coordinate projections via the <a href="http://proj4.org/">PROJ.4</a> library:</p>
<pre class="sourceCode r" id="cb21"><code class="sourceCode r"><div class="sourceLine" id="cb21-1" data-line-number="1">modify_StopPoints &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb21-2" data-line-number="2">  <span class="co"># Define proj4 coordinate systems</span></div>
<div class="sourceLine" id="cb21-3" data-line-number="3">  bng =<span class="st"> &quot;+init=epsg:27700&quot;</span></div>
<div class="sourceLine" id="cb21-4" data-line-number="4">  latlon =<span class="st"> &quot;+proj=longlat +datum=WGS84&quot;</span></div>
<div class="sourceLine" id="cb21-5" data-line-number="5"></div>
<div class="sourceLine" id="cb21-6" data-line-number="6">  <span class="co"># Create spatial object using BNG coordinates</span></div>
<div class="sourceLine" id="cb21-7" data-line-number="7">  coord.bng &lt;-</div>
<div class="sourceLine" id="cb21-8" data-line-number="8"><span class="st">    </span><span class="kw">with</span>(df,</div>
<div class="sourceLine" id="cb21-9" data-line-number="9">         <span class="kw">SpatialPointsDataFrame</span>(<span class="kw">cbind</span>(Place_Location_Easting, Place_Location_Northing) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb21-10" data-line-number="10"><span class="st">                                  </span><span class="kw">as.integer</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="dv">2</span>),</div>
<div class="sourceLine" id="cb21-11" data-line-number="11">                                <span class="dt">data =</span> <span class="kw">tibble</span>(AtcoCode,</div>
<div class="sourceLine" id="cb21-12" data-line-number="12">                                              Descriptor_CommonName,</div>
<div class="sourceLine" id="cb21-13" data-line-number="13">                                              Place_NptgLocalityRef),</div>
<div class="sourceLine" id="cb21-14" data-line-number="14">                                <span class="dt">proj4string =</span> <span class="kw">CRS</span>(bng)))</div>
<div class="sourceLine" id="cb21-15" data-line-number="15"></div>
<div class="sourceLine" id="cb21-16" data-line-number="16">  <span class="co"># Cast as latlon coordinates</span></div>
<div class="sourceLine" id="cb21-17" data-line-number="17">  coord.latlon &lt;-<span class="st"> </span><span class="kw">spTransform</span>(coord.bng, <span class="kw">CRS</span>(latlon))</div>
<div class="sourceLine" id="cb21-18" data-line-number="18"></div>
<div class="sourceLine" id="cb21-19" data-line-number="19">  <span class="co"># Replace dataframe</span></div>
<div class="sourceLine" id="cb21-20" data-line-number="20">  df &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(coord.latlon)</div>
<div class="sourceLine" id="cb21-21" data-line-number="21">  <span class="kw">names</span>(df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AtcoCode&quot;</span>,<span class="st">&quot;CommonName&quot;</span>,<span class="st">&quot;NptgLocalityRef&quot;</span>,<span class="st">&quot;Longitude&quot;</span>,<span class="st">&quot;Latitude&quot;</span>)</div>
<div class="sourceLine" id="cb21-22" data-line-number="22">  df</div>
<div class="sourceLine" id="cb21-23" data-line-number="23">}</div></code></pre>
<h3 id="journeytime-and-departuremins">JourneyTime and DepartureMins</h3>
<p>Perhaps the most significant variable is the RunTime of each journey section as it supposedly tells us the travel time between two StopPoints.</p>
<pre class="sourceCode r" id="cb22"><code class="sourceCode r"><div class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">table</span>(tfl<span class="op">$</span>JourneyPatternTimingLinks<span class="op">$</span>RunTime)</div></code></pre>
<p>Unfortunately this frequency table shows that the duration is presented as a text field where it’s assumed the “M” indicates the RunTime is rounded to the nearest minute. Judging by the “0S” field, this would also suggest that a huge number of links take zero seconds! Clearly the duration has been rounded to the nearest minute however it also turns out that every instance of zero RunTime has at least 1 minute of WaitTime at the next station.</p>
<pre class="sourceCode r" id="cb23"><code class="sourceCode r"><div class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># Check that there aren't records with both no WaitTime and zero RunTime</span></div>
<div class="sourceLine" id="cb23-2" data-line-number="2">tfl<span class="op">$</span>JourneyPatternTimingLinks <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb23-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(WaitTime) <span class="op">&amp;&amp;</span><span class="st"> </span>RunTime <span class="op">==</span><span class="st"> &quot;PT0S&quot;</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb23-4" data-line-number="4"><span class="st">  </span>nrow <span class="op">==</span><span class="st"> </span><span class="dv">0</span></div></code></pre>
<p>Therefore, we can convert the RunTime and WaitTime to integer variables by extracting the third character from every observation and build a new variable JourneyTime which takes into account the total RunTime and WaitTime which we now know will always be at least 1 minute:</p>
<pre class="sourceCode r" id="cb24"><code class="sourceCode r"><div class="sourceLine" id="cb24-1" data-line-number="1">modify_JourneyPatternTimingLinks &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb24-2" data-line-number="2">  <span class="kw">within</span>(df, {</div>
<div class="sourceLine" id="cb24-3" data-line-number="3">    From_SequenceNumber <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb24-4" data-line-number="4">    To_SequenceNumber <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb24-5" data-line-number="5">    <span class="co"># Extract timings from RunTime and WaitTime to create JourneyTime</span></div>
<div class="sourceLine" id="cb24-6" data-line-number="6">    RunTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">substr</span>(<span class="dv">3</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb24-7" data-line-number="7">    WaitTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">substr</span>(<span class="dv">3</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb24-8" data-line-number="8">    JourneyTime &lt;-<span class="st"> </span>RunTime <span class="op">+</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(WaitTime), <span class="dv">0</span>, WaitTime)</div>
<div class="sourceLine" id="cb24-9" data-line-number="9">  })</div>
<div class="sourceLine" id="cb24-10" data-line-number="10">}</div></code></pre>
<p>The other most important field is the departure times of every train from their origin station, DepartureTime, which is currently stored as text.</p>
<pre class="sourceCode r" id="cb25"><code class="sourceCode r"><div class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">head</span>(tfl<span class="op">$</span>VehicleJourneys<span class="op">$</span>DepartureTime)</div></code></pre>
<p>So it looks like this variable is a time stamp which is also rounded to the nearest minute.</p>
<p>Since we are now dealing solely in minutes, it would make the most sense to cast this DepartureTime field as the number of minutes since midnight. This makes it less human-readable however addition of DepartureTime and JourneyTime is now very straightforward and doesn’t rely on datetime typecasting or datediff functions. That said, in the event that we’re using a database that handles datetimes well, it doesn’t hurt to correctly cast DepartureTime and keep it in the data frame separately.</p>
<pre class="sourceCode r" id="cb26"><code class="sourceCode r"><div class="sourceLine" id="cb26-1" data-line-number="1">modify_VehicleJourneys &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb26-2" data-line-number="2">  <span class="kw">within</span>(df, {</div>
<div class="sourceLine" id="cb26-3" data-line-number="3">    DepartureTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="dt">format=</span><span class="st">&quot;%T&quot;</span>)</div>
<div class="sourceLine" id="cb26-4" data-line-number="4">    <span class="co"># Extract number of minutes since midnight from DepartureTime</span></div>
<div class="sourceLine" id="cb26-5" data-line-number="5">    DepartureMins &lt;-<span class="st"> </span>DepartureTime <span class="op">%&gt;%</span><span class="st"> </span>{lubridate<span class="op">::</span><span class="kw">minute</span>(.) <span class="op">+</span><span class="st"> </span><span class="dv">60</span> <span class="op">*</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">hour</span>(.)}</div>
<div class="sourceLine" id="cb26-6" data-line-number="6">  })</div>
<div class="sourceLine" id="cb26-7" data-line-number="7">}</div></code></pre>
<h1 id="normalisation-and-relational-databases">Normalisation and Relational Databases</h1>
<p>As found in the previous section, the dataset is provided in a fairly normalised form already (3rd normal form for nearly every table). This makes it very easy to simply push the tables as-is to a database whilst specifying the various primary and foreign key relations between each table.</p>
<h2 id="dbms-setup">DBMS Setup</h2>
<p>Due to the information given to us, the queries to be computed in-database are quite advanced and require running cumulative calculations and row offsets by group which are only available in an advanced DBMS and not SQLite or MySQL.</p>
<p>For this reason, we’ll use an open-source database PostgreSQL for its <a href="http://www.postgresqltutorial.com/postgresql-window-function/">windowing functions</a> though other proprietary databases such as Oracle or Microsoft also provide this functionality. Thanks to <a href="https://www.docker.com/what-docker">Docker</a> containers, provisioning a clean lightweight Postgres database on your local machine is one line of code without any additional setup other than downloading Docker itself.</p>
<pre class="sourceCode bash" id="cb27"><code class="sourceCode bash"><div class="sourceLine" id="cb27-1" data-line-number="1"><span class="co"># docker run --name postgres_london_tube -p 5432:5432 -d -e POSTGRES_PASSWORD=mysecretpassword postgres:alpine</span></div>
<div class="sourceLine" id="cb27-2" data-line-number="2"></div>
<div class="sourceLine" id="cb27-3" data-line-number="3"><span class="co">#' Define row uniqueness</span></div></code></pre>
<p><em>The alpine image is about 1/10th the size of the official postgres container as it uses a significantly smaller distribution of Linux with fewer of postgres’ auxilliary features.</em></p>
<p>Test that the server is running and the connection works by setting up a development database for the project:</p>
<pre class="sourceCode r" id="cb28"><code class="sourceCode r"><div class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">library</span>(RPostgreSQL)</div>
<div class="sourceLine" id="cb28-2" data-line-number="2"></div>
<div class="sourceLine" id="cb28-3" data-line-number="3">drv &lt;-<span class="st"> </span><span class="kw">dbDriver</span>(<span class="st">&quot;PostgreSQL&quot;</span>)</div>
<div class="sourceLine" id="cb28-4" data-line-number="4">host &lt;-<span class="st"> &quot;localhost&quot;</span></div>
<div class="sourceLine" id="cb28-5" data-line-number="5">user &lt;-<span class="st"> &quot;postgres&quot;</span></div>
<div class="sourceLine" id="cb28-6" data-line-number="6">password &lt;-<span class="st"> &quot;mysecretpassword&quot;</span></div>
<div class="sourceLine" id="cb28-7" data-line-number="7"></div>
<div class="sourceLine" id="cb28-8" data-line-number="8">con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(drv, <span class="dt">host =</span> host, <span class="dt">user =</span> user, <span class="dt">password =</span> password,</div>
<div class="sourceLine" id="cb28-9" data-line-number="9">                 <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>)</div>
<div class="sourceLine" id="cb28-10" data-line-number="10"><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;CREATE DATABASE londontube;&quot;</span>)</div>
<div class="sourceLine" id="cb28-11" data-line-number="11"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<pre class="sourceCode r" id="cb29"><code class="sourceCode r"><div class="sourceLine" id="cb29-1" data-line-number="1">get_con &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">dbConnect</span>(<span class="dt">drv =</span> <span class="kw">dbDriver</span>(<span class="st">&quot;PostgreSQL&quot;</span>), <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</div>
<div class="sourceLine" id="cb29-2" data-line-number="2">                                <span class="dt">dbname =</span> <span class="st">&quot;londontube&quot;</span>,</div>
<div class="sourceLine" id="cb29-3" data-line-number="3">                                <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>, <span class="dt">password =</span> <span class="st">&quot;mysecretpassword&quot;</span>)</div></code></pre>
<h2 id="build-database">Build database</h2>
<p>Using the primary keys and data types found in the previous section, we can write a function that drops an existing table, builds a new table with the provided keys and data types and populates the table with data. Now, the entire database can be created in one hit by using <code>pmap</code> to loop the function over all eight tables sequentially.</p>
<pre class="sourceCode r" id="cb30"><code class="sourceCode r"><div class="sourceLine" id="cb30-1" data-line-number="1">create_tables &lt;-<span class="st"> </span><span class="cf">function</span>(tablename, tabledata, con){</div>
<div class="sourceLine" id="cb30-2" data-line-number="2">  <span class="kw">dbWriteTable</span>(con, tablename, tabledata, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</div>
<div class="sourceLine" id="cb30-3" data-line-number="3">}</div>
<div class="sourceLine" id="cb30-4" data-line-number="4"></div>
<div class="sourceLine" id="cb30-5" data-line-number="5"><span class="co"># Build database with the same tablenames as input data</span></div>
<div class="sourceLine" id="cb30-6" data-line-number="6">con &lt;-<span class="st"> </span><span class="kw">get_con</span>()</div>
<div class="sourceLine" id="cb30-7" data-line-number="7">table_creation &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">pmap</span>(<span class="kw">list</span>(<span class="kw">tolower</span>(<span class="kw">names</span>(tfl)), tfl), create_tables, con)</div>
<div class="sourceLine" id="cb30-8" data-line-number="8"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<p>Finally we can check that the tables were loaded successfully:</p>
<pre class="sourceCode r" id="cb31"><code class="sourceCode r"><div class="sourceLine" id="cb31-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">get_con</span>()</div>
<div class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw">dbListTables</span>(con)</div>
<div class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<h2 id="joining-tables">Joining Tables</h2>
<p>To build out the timetable, we’ve seen that there are two crucial tables:</p>
<ul>
<li><strong>VehicleJourneys</strong> which lists each train and its time of departure from the journey origin</li>
<li><strong>JourneyPatternTimingLinks</strong> contains the sequence of stops for each possible journey and the journey time of each link</li>
</ul>
<p>What we’re after is a network-wide departures board which has the time of departure from each <em>station</em> and not just the train origin. Therefore, it’s a matter of expanding out every Vehicle Journey by the number of sequences in the Journey Pattern to calculate each Vehicle Link departure.</p>
<p>The departures board table is achieved as follows:</p>
<ol>
<li>Join <strong>VehicleJourneys</strong> to <strong>JourneyPatternTimingLinks</strong> via <strong>JourneyPatterns</strong></li>
<li>Calculate <em>ArrivalMins_Link</em> (arrival time of each train into each station) as the origin departure time (<em>DepartureMins</em>) plus the cumulative sum of <em>JourneyTime</em> ordered by link sequence for each vehicle</li>
<li>Calculate <em>DepartureMins_Link</em> as the preceding link’s arrival time. For the first link, it’s the origin departure time.</li>
</ol>
<p>For analysis later on, we also want to flag whether the link is the last trip in the vehicle’s journey. This just involves checking whether the link sequence is the largest value for that vehicle.</p>
<p>As you can imagine, this table is pretty big at 6,632,701 rows. In fact, as discussed earlier, the vast majority of it is redundant information. Entire XML files are duplicated for special calendar days such as Bank Holidays, New Years, Christmas etc. hence the need to sample the data. When we pushed the data to Postgres, the Python code scraped every file for completeness so this sampling now occurs as part of the departures board query. Essentially we just filter on the Operating Profile of the Services and Vehicle Journeys to be one day of the week and filter the Operating Periods to be those that contain a given date. Now, by passing in the date Wednesday 20th Dec 2017 the table size has reduced to 243,847 rows.</p>
<h2 id="advanced-queries">Advanced Queries</h2>
<p>With a properly normalised database we can now go on to query the data in infinitely many ways. One such example would be to answer the question</p>
<blockquote>
<p>How many trains are in the network at 8:37am on Monday 18th December 2017 and where are they?</p>
</blockquote>
<p>One way to go about this is to filter the Departures Board based on 8:37am being between the train origin departure time (inclusive) and arrival time at the last stop (exclusive).</p>
<p>To get the total number of trains in the network we just need to count the unique number of vehicles in this result set. The tricky part is determining <em>where</em> each train is because of the trains which are not exactly at a station at 8:37am.</p>
<p>If a train arrives exactly at 8:37am it will get double counted as both a departure and arrival (since these happen instantaneously on the minute) so we first need to filter to the trip links where the trains are at or <em>approaching</em> a station.</p>
<p>The last step is to filter to a single link for each vehicle that is <em>closest</em> to 8:37am. The final result set is the trains in the network at 8:37am with the name of the stop where they are either exactly stationed or next arriving.</p>
<pre class="sourceCode sql" id="cb32"><code class="sourceCode sql"><div class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">WITH</span> VehiclePointInTime <span class="kw">AS</span> (</div>
<div class="sourceLine" id="cb32-2" data-line-number="2"></div>
<div class="sourceLine" id="cb32-3" data-line-number="3"><span class="kw">SELECT</span></div>
<div class="sourceLine" id="cb32-4" data-line-number="4">     *</div>
<div class="sourceLine" id="cb32-5" data-line-number="5">     <span class="co">-- Calculate the number of minutes since @ArrivalTime only for trips arriving on or after @ArrivalTime</span></div>
<div class="sourceLine" id="cb32-6" data-line-number="6">    ,<span class="kw">CASE</span> <span class="kw">WHEN</span> <span class="ot">&quot;ArrivalMins_Link&quot;</span> - <span class="dv">540</span> &lt; <span class="dv">0</span></div>
<div class="sourceLine" id="cb32-7" data-line-number="7">        <span class="kw">THEN</span> <span class="kw">NULL</span></div>
<div class="sourceLine" id="cb32-8" data-line-number="8">        <span class="kw">ELSE</span> <span class="ot">&quot;ArrivalMins_Link&quot;</span> - <span class="dv">540</span></div>
<div class="sourceLine" id="cb32-9" data-line-number="9">     <span class="kw">END</span> <span class="kw">AS</span> <span class="ot">&quot;PosAtTime&quot;</span></div>
<div class="sourceLine" id="cb32-10" data-line-number="10"><span class="kw">FROM</span> departures</div>
<div class="sourceLine" id="cb32-11" data-line-number="11"><span class="co">-- Filter to only trips that were online in the network as at @ArrivalTime</span></div>
<div class="sourceLine" id="cb32-12" data-line-number="12"><span class="kw">WHERE</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span> <span class="kw">IN</span></div>
<div class="sourceLine" id="cb32-13" data-line-number="13">    (</div>
<div class="sourceLine" id="cb32-14" data-line-number="14">        <span class="kw">SELECT</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb32-15" data-line-number="15">        <span class="kw">FROM</span> departures</div>
<div class="sourceLine" id="cb32-16" data-line-number="16">        <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb32-17" data-line-number="17">        <span class="co">-- Time is between the train origin departure time (inclusive) and arrival time at the last stop (exclusive)</span></div>
<div class="sourceLine" id="cb32-18" data-line-number="18">        <span class="kw">HAVING</span> <span class="dv">540</span> &gt;= <span class="fu">MIN</span>(<span class="ot">&quot;DepartureMins_Link&quot;</span>) <span class="kw">AND</span> <span class="dv">540</span> &lt; <span class="fu">MAX</span>(<span class="ot">&quot;ArrivalMins_Link&quot;</span>)</div>
<div class="sourceLine" id="cb32-19" data-line-number="19">    )</div>
<div class="sourceLine" id="cb32-20" data-line-number="20">)</div>
<div class="sourceLine" id="cb32-21" data-line-number="21"></div>
<div class="sourceLine" id="cb32-22" data-line-number="22"><span class="kw">SELECT</span> a.*</div>
<div class="sourceLine" id="cb32-23" data-line-number="23"><span class="kw">FROM</span> VehiclePointInTime a</div>
<div class="sourceLine" id="cb32-24" data-line-number="24"><span class="co">-- Filter previous query to one link per vehicle journey that is closest to @ArrivalTime</span></div>
<div class="sourceLine" id="cb32-25" data-line-number="25"><span class="kw">LEFT</span> <span class="kw">JOIN</span> (</div>
<div class="sourceLine" id="cb32-26" data-line-number="26"></div>
<div class="sourceLine" id="cb32-27" data-line-number="27">    <span class="kw">SELECT</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span>, <span class="fu">MIN</span>(<span class="ot">&quot;PosAtTime&quot;</span>) <span class="ot">&quot;MinPosAtTime&quot;</span></div>
<div class="sourceLine" id="cb32-28" data-line-number="28">    <span class="kw">FROM</span> VehiclePointInTime</div>
<div class="sourceLine" id="cb32-29" data-line-number="29">    <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb32-30" data-line-number="30"></div>
<div class="sourceLine" id="cb32-31" data-line-number="31">) b <span class="kw">ON</span> a.<span class="ot">&quot;VehicleJourneyCode&quot;</span> = b.<span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb32-32" data-line-number="32"></div>
<div class="sourceLine" id="cb32-33" data-line-number="33"><span class="kw">WHERE</span> <span class="ot">&quot;PosAtTime&quot;</span> = <span class="ot">&quot;MinPosAtTime&quot;</span></div>
<div class="sourceLine" id="cb32-34" data-line-number="34"><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="ot">&quot;FromSequenceNumber&quot;</span></div></code></pre>

</body>
</html>
