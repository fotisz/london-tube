<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style type="text/css">
@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}
body {
-webkit-text-size-adjust: 100%;
text-size-adjust: 100%;
color: #333;
font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.6;
word-wrap: break-word;
}
a {
background-color: transparent;
}
a:active,
a:hover {
outline: 0;
}
strong {
font-weight: bold;
}
h1 {
font-size: 2em;
margin: 0.67em 0;
}
img {
border: 0;
}
hr {
box-sizing: content-box;
height: 0;
}
pre {
overflow: auto;
}
code,
kbd,
pre {
font-family: monospace, monospace;
font-size: 1em;
}
input {
color: inherit;
font: inherit;
margin: 0;
}
html input[disabled] {
cursor: default;
}
input {
line-height: normal;
}
input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
table {
border-collapse: collapse;
border-spacing: 0;
}
td,
th {
padding: 0;
}
* {
box-sizing: border-box;
}
input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a {
color: #4078c0;
text-decoration: none;
}
a:hover,
a:active {
text-decoration: underline;
}
hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
hr:before {
display: table;
content: "";
}
hr:after {
display: table;
clear: both;
content: "";
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
h1 {
font-size: 30px;
}
h2 {
font-size: 21px;
}
h3 {
font-size: 16px;
}
h4 {
font-size: 14px;
}
h5 {
font-size: 12px;
}
h6 {
font-size: 11px;
}
blockquote {
margin: 0;
}
ul,
ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
ol ol,
ul ol {
list-style-type: lower-roman;
}
ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
list-style-type: lower-alpha;
}
dd {
margin-left: 0;
}
code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.select::-ms-expand {
opacity: 0;
}
.octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
a:not([href]) {
color: inherit;
text-decoration: none;
}
.anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.anchor:focus {
outline: none;
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
text-decoration: none;
}
h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
visibility: visible;
}
h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
h1 .anchor {
line-height: 1;
}
h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
h2 .anchor {
line-height: 1;
}
h3 {
font-size: 1.5em;
line-height: 1.43;
}
h3 .anchor {
line-height: 1.2;
}
h4 {
font-size: 1.25em;
}
h4 .anchor {
line-height: 1.2;
}
h5 {
font-size: 1em;
}
h5 .anchor {
line-height: 1.1;
}
h6 {
font-size: 1em;
color: #777;
}
h6 .anchor {
line-height: 1.1;
}
p,
blockquote,
ul,
ol,
dl,
table,
pre {
margin-top: 0;
margin-bottom: 16px;
}
hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
ul,
ol {
padding-left: 2em;
}
ul ul,
ul ol,
ol ol,
ol ul {
margin-top: 0;
margin-bottom: 0;
}
li>p {
margin-top: 16px;
}
dl {
padding: 0;
}
dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
blockquote>:first-child {
margin-top: 0;
}
blockquote>:last-child {
margin-bottom: 0;
}
table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
table th {
font-weight: bold;
}
table th,
table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
table tr:nth-child(2n) {
background-color: #f8f8f8;
}
img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
code:before,
code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.highlight {
margin-bottom: 16px;
}
.highlight pre,
pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.highlight pre {
margin-bottom: 0;
word-break: normal;
}
pre {
word-wrap: normal;
}
pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
pre code:before,
pre code:after {
content: normal;
}
kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.pl-c {
color: #969896;
}
.pl-c1,
.pl-s .pl-v {
color: #0086b3;
}
.pl-e,
.pl-en {
color: #795da3;
}
.pl-s .pl-s1,
.pl-smi {
color: #333;
}
.pl-ent {
color: #63a35c;
}
.pl-k {
color: #a71d5d;
}
.pl-pds,
.pl-s,
.pl-s .pl-pse .pl-s1,
.pl-sr,
.pl-sr .pl-cce,
.pl-sr .pl-sra,
.pl-sr .pl-sre {
color: #183691;
}
.pl-v {
color: #ed6a43;
}
.pl-id {
color: #b52a1d;
}
.pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.pl-ml {
color: #693a17;
}
.pl-mh,
.pl-mh .pl-en,
.pl-ms {
color: #1d3e81;
font-weight: bold;
}
.pl-mq {
color: #008080;
}
.pl-mi {
color: #333;
font-style: italic;
}
.pl-mb {
color: #333;
font-weight: bold;
}
.pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.pl-mdr {
color: #795da3;
font-weight: bold;
}
.pl-mo {
color: #1d3e81;
}
kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.task-list-item {
list-style-type: none;
}
.task-list-item+.task-list-item {
margin-top: 3px;
}
.task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
:checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
.sourceLine {
display: inline-block;
}
code .kw { color: #000000; }
code .dt { color: #ed6a43; }
code .dv { color: #009999; }
code .bn { color: #009999; }
code .fl { color: #009999; }
code .ch { color: #009999; }
code .st { color: #183691; }
code .co { color: #969896; }
code .ot { color: #0086b3; }
code .al { color: #a61717; }
code .fu { color: #63a35c; }
code .er { color: #a61717; background-color: #e3d2d2; }
code .wa { color: #000000; }
code .cn { color: #008080; }
code .sc { color: #008080; }
code .vs { color: #183691; }
code .ss { color: #183691; }
code .im { color: #000000; }
code .va {color: #008080; }
code .cf { color: #000000; }
code .op { color: #000000; }
code .bu { color: #000000; }
code .ex { color: #000000; }
code .pp { color: #999999; }
code .at { color: #008080; }
code .do { color: #969896; }
code .an { color: #008080; }
code .cv { color: #008080; }
code .in { color: #008080; }
</style>
<style>
body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
  padding-top: 0px;
}
</style>

</head>

<body>

<h1 id="part-one-managing-data">Part One: Managing Data</h1>
<p><a href="index.html">Back to Home</a></p>
<h1 id="introduction">Introduction</h1>
<p>This notebook forms the first of two outputs in the analysis of the TfL London Tube network. It is primarily concerned with the transformation and manipulation of the required datasets in comparison to Part Two which focuses on visualisation and algorithms.</p>
<p>Due to the complexity of the dataset being investigated, there are a few external references to analysis files in this repository which go into greater detail regarding the transformations and data extraction performed which do not form part of the notebook. Further, the data manipulation code shown here is wholly R however when it came to extracting the data in practice this was re-written in Python for performance reasons. Therefore this code is to illustrate the initial extraction and data discovery thought-process more-so than the efficient (or recommended) extraction process.</p>
<h1 id="apis-and-internet-data">APIs and Internet Data</h1>
<p>We start the project with a reproducible way of pulling the dataset from the API download link. The results shown in this notebook relate to the API feed as at 12th December 2017.</p>
<p>To access it, download the zip file at the link below</p>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><div class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Use paths relative to RStudio Project</span></div>
<div class="sourceLine" id="cb1-2" data-line-number="2">root.dir &lt;-<span class="st"> </span>rprojroot<span class="op">::</span><span class="kw">find_rstudio_root_file</span>()</div>
<div class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Set where we want the extracted files to end up</span></div>
<div class="sourceLine" id="cb1-4" data-line-number="4">data.dir &lt;-<span class="st"> </span><span class="kw">file.path</span>(root.dir, <span class="st">&quot;1_data/1_1_raw_data&quot;</span>)</div>
<div class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">dir.create</span>(data.dir, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</div></code></pre>
<pre class="sourceCode r" id="cb2"><code class="sourceCode r"><div class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Load app_id and app_key variables from a local passwords file</span></div>
<div class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">source</span>(<span class="kw">file.path</span>(root.dir, <span class="st">&quot;2_analysis/r/tfl-developer-passwords.R&quot;</span>))</div>
<div class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">stopifnot</span>(<span class="kw">exists</span>(<span class="st">&quot;app_id&quot;</span>), <span class="kw">exists</span>(<span class="st">&quot;app_key&quot;</span>))</div>
<div class="sourceLine" id="cb2-4" data-line-number="4">dataset_url &lt;-<span class="st"> &quot;http://data.tfl.gov.uk/tfl/syndication/feeds/journey-planner-timetables.zip&quot;</span></div>
<div class="sourceLine" id="cb2-5" data-line-number="5">dataset_url &lt;-<span class="st"> </span><span class="kw">paste0</span>(dataset_url, <span class="st">&quot;?app_id=&quot;</span>, app_id, <span class="st">&quot;&amp;app_key=&quot;</span>, app_key)</div>
<div class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">download.file</span>(dataset_url, <span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables.zip&quot;</span>))</div></code></pre>
<p><em>Note: You may need to <a href="https://api-portal.tfl.gov.uk/">register</a> for an API key and update the file <code>tfl-developer-passwords.R</code> to access the zip file. In the event that you cannot gain access there is a small demo sample <a href="https://tfl.gov.uk/cdn/static/cms/documents/journey-planner-timetables.zip">here</a> or you can use the full extract provided with this repository</em></p>
<p>Unpack the download once to split out the train/ferry timetables from the bus timetables and again to unpack the tube/DLR timetables.</p>
<pre class="sourceCode r" id="cb3"><code class="sourceCode r"><div class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">unzip</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables.zip&quot;</span>),</div>
<div class="sourceLine" id="cb3-2" data-line-number="2">      <span class="dt">exdir =</span> <span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables&quot;</span>))</div>
<div class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">unzip</span>(<span class="kw">list.files</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;timetables&quot;</span>),</div>
<div class="sourceLine" id="cb3-4" data-line-number="4">                 <span class="dt">pattern =</span> <span class="st">&quot;LULDLR&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>),</div>
<div class="sourceLine" id="cb3-5" data-line-number="5">      <span class="dt">exdir =</span> <span class="kw">file.path</span>(data.dir, <span class="st">&quot;/timetables/data&quot;</span>))</div></code></pre>
<pre class="sourceCode r" id="cb4"><code class="sourceCode r"><div class="sourceLine" id="cb4-1" data-line-number="1">data.files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">file.path</span>(data.dir, <span class="st">&quot;/timetables/data&quot;</span>),</div>
<div class="sourceLine" id="cb4-2" data-line-number="2">                         <span class="dt">pattern =</span> <span class="st">&quot;tfl_1-[^.]+</span><span class="ch">\\</span><span class="st">.xml&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</div>
<div class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">head</span>(<span class="kw">basename</span>(data.files))</div></code></pre>
<pre><code>## [1] &quot;tfl_1-BAK-_-y05-1462422.xml&quot; &quot;tfl_1-BAK-_-y05-1462611.xml&quot;
## [3] &quot;tfl_1-BAK-_-y05-1462711.xml&quot; &quot;tfl_1-BAK-_-y05-1463122.xml&quot;
## [5] &quot;tfl_1-BAK-_-y05-1463222.xml&quot; &quot;tfl_1-BAK-_-y05-1465129.xml&quot;
</code></pre>
<p>The result is 600-800MB of XML files containing the most up-to-date timetable information for the London Underground and DLR services. The pattern of London Underground files we require are XML files that start with “tfl_1” as the files with other prefixes are ferry, DLR or TfL rail timetables.</p>
<h1 id="data-exploration-and-transformation">Data Exploration and Transformation</h1>
<p>For this section, we’ll investigate the structure of the API feed, ways to extract the important data, manipulate it into the required shape and add any necessary calculations. This will be demonstrated for one of the XML files in a manner which can be generalised for any other timetable.</p>
<h2 id="xml-metadata">XML Metadata</h2>
<p>Begin by reading in the first XML file.</p>
<p><em>NB: The <code>xml2</code>, <code>XML</code> and <code>xmltools</code> package namespaces are not loaded via <code>library</code> in order to illustrate which functions belong to each package more clearly by using <code>::</code> for each function call.</em></p>
<pre class="sourceCode r" id="cb6"><code class="sourceCode r"><div class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(magrittr)</div>
<div class="sourceLine" id="cb6-2" data-line-number="2">doc &lt;-<span class="st"> </span>data.files[<span class="dv">1</span>] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">read_xml</span>()</div>
<div class="sourceLine" id="cb6-4" data-line-number="4">doc</div></code></pre>
<pre><code>## {xml_document}
## &lt;TransXChange CreationDateTime=&quot;2017-12-11T16:29:29.2501241Z&quot; ModificationDateTime=&quot;2017-12-11T16:29:29.2501241Z&quot; Modification=&quot;new&quot; FileName=&quot;tfl_1-BAK-_-y05-1462422.xml&quot; RevisionNumber=&quot;3&quot; SchemaVersion=&quot;2.1&quot; lang=&quot;en&quot; schemaLocation=&quot;http://www.transxchange.org.uk/ http://www.transxchange.org.uk/schema/2.1/TransXChange_general.xsd&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.transxchange.org.uk/&quot;&gt;
## [1] &lt;NptgLocalities&gt;\n  &lt;AnnotatedNptgLocalityRef&gt;\n    &lt;NptgLocalityRef ...
## [2] &lt;StopPoints&gt;\n  &lt;StopPoint CreationDateTime=&quot;2013-08-29T00:00:00&quot;&gt;\n ...
## [3] &lt;RouteSections&gt;\n  &lt;RouteSection id=&quot;RS_1-BAK-_-y05-1462422-O-1&quot;&gt;\n  ...
## [4] &lt;Routes&gt;\n  &lt;Route id=&quot;R_1-BAK-_-y05-1462422-O-1&quot;&gt;\n    &lt;PrivateCode ...
## [5] &lt;JourneyPatternSections&gt;\n  &lt;JourneyPatternSection id=&quot;JPS_1-BAK-_-y ...
## [6] &lt;Operators&gt;\n  &lt;Operator id=&quot;OId_LUL&quot;&gt;\n    &lt;OperatorCode&gt;LUL&lt;/Opera ...
## [7] &lt;Services&gt;\n  &lt;Service&gt;\n    &lt;ServiceCode&gt;1-BAK-_-y05-1462422&lt;/Servi ...
## [8] &lt;VehicleJourneys&gt;\n  &lt;VehicleJourney&gt;\n    &lt;PrivateCode&gt;tfl-1-BAK-_- ...
</code></pre>
<p>This metadata contains two important pieces of information:</p>
<ol>
<li><p>The top level node contains <em>eight</em> distinct child nodes which appear to be completely disparate datasets all relating to this particular file:</p>
<ul>
<li>The <a href="https://en.wikipedia.org/wiki/NaPTAN#NaPTAN_Stops"><em>StopPoints</em></a> provide the stop locations which group up to a given stop “locality” in <a href="https://www.gov.uk/government/publications/national-public-transport-gazetteer"><em>NptgLocalities</em></a>.</li>
<li>The <em>Routes</em> are broken down into <em>RouteSections</em> and <em>JourneyPatternSections</em></li>
<li>The <em>Operator</em> is not useful for the Tube data as there is only one; “LUL”</li>
<li>Each <em>Service</em> is how the file derives its name so there’s one in each XML file</li>
<li>The <em>VehicleJourney</em> is the most granular level of information as it provides the exact trip link of a vehicle moving from one station to the next in a given <em>JourneyPatternSection</em></li>
</ul></li>
<li><p>The namespace of the XML file is non-standard. The <code>schemaLocation</code> attribute suggests that the XML structure adheres to the <a href="https://www.gov.uk/government/collections/transxchange"><em>TransXChange</em></a> schema provided by the UK Department for Transport for timetable data. We can configure this namespace for use with any future XPaths (the alternative is to simply strip it entirely from the file however this takes additional processing time).</p></li>
</ol>
<!-- end list -->

<pre class="sourceCode r" id="cb8"><code class="sourceCode r"><div class="sourceLine" id="cb8-1" data-line-number="1">namespace &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">txc =</span> <span class="st">&quot;http://www.transxchange.org.uk/&quot;</span>)</div></code></pre>
<p>Once we set up an extraction procedure for this schema and namespace it can then be applied to <em>any</em> timetable that adheres to DfT standards.</p>
<h2 id="dataset-structure">Dataset Structure</h2>
<p>To quickly get an idea of the structure we can traverse the document as a list:</p>
<pre class="sourceCode r" id="cb9"><code class="sourceCode r"><div class="sourceLine" id="cb9-1" data-line-number="1">xml_list &lt;-<span class="st"> </span>doc <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">as_list</span>()</div></code></pre>
<p>and inspect the structure of a given observation for each of the 8 tables along with an example of the data that each XML node (or attribute) contains.</p>
<pre class="sourceCode r" id="cb10"><code class="sourceCode r"><div class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>NptgLocalities<span class="op">$</span>AnnotatedNptgLocalityRef)</div></code></pre>
<pre><code>## List of 2
##  $ NptgLocalityRef:List of 1
##   ..$ : chr &quot;N0077657&quot;
##  $ LocalityName   :List of 1
##   ..$ : chr &quot;Elephant &amp; Castle&quot;
</code></pre>
<pre class="sourceCode r" id="cb12"><code class="sourceCode r"><div class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>StopPoints<span class="op">$</span>StopPoint)</div></code></pre>
<pre><code>## List of 6
##  $ AtcoCode             :List of 1
##   ..$ : chr &quot;9400ZZLUEAC1&quot;
##  $ Descriptor           :List of 1
##   ..$ CommonName:List of 1
##   .. ..$ : chr &quot;Elephant &amp; Castle Station&quot;
##  $ Place                :List of 2
##   ..$ NptgLocalityRef:List of 1
##   .. ..$ : chr &quot;N0077657&quot;
##   ..$ Location       :List of 2
##   .. ..$ Easting :List of 1
##   .. .. ..$ : chr &quot;531920&quot;
##   .. ..$ Northing:List of 1
##   .. .. ..$ : chr &quot;179140&quot;
##   .. ..- attr(*, &quot;Precision&quot;)= chr &quot;1m&quot;
##  $ StopClassification   :List of 2
##   ..$ StopType :List of 1
##   .. ..$ : chr &quot;RPL&quot;
##   ..$ OffStreet:List of 1
##   .. ..$ Rail:List of 1
##   .. .. ..$ Platform: list()
##  $ AdministrativeAreaRef:List of 1
##   ..$ : chr &quot;000&quot;
##  $ Notes                :List of 1
##   ..$ : chr &quot;Elephant &amp; Castle Station&quot;
##  - attr(*, &quot;CreationDateTime&quot;)= chr &quot;2013-08-29T00:00:00&quot;
</code></pre>
<pre class="sourceCode r" id="cb14"><code class="sourceCode r"><div class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>RouteSections<span class="op">$</span>RouteSection[[<span class="dv">1</span>]])</div></code></pre>
<pre><code>## List of 4
##  $ From     :List of 1
##   ..$ StopPointRef:List of 1
##   .. ..$ : chr &quot;9400ZZLUEAC1&quot;
##  $ To       :List of 1
##   ..$ StopPointRef:List of 1
##   .. ..$ : chr &quot;9400ZZLULBN1&quot;
##  $ Distance :List of 1
##   ..$ : chr &quot;852&quot;
##  $ Direction:List of 1
##   ..$ : chr &quot;outbound&quot;
##  - attr(*, &quot;id&quot;)= chr &quot;RL_1-BAK-_-y05-1462422-O-1-1&quot;
</code></pre>
<pre class="sourceCode r" id="cb16"><code class="sourceCode r"><div class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>Routes<span class="op">$</span>Route)</div></code></pre>
<pre><code>## List of 3
##  $ PrivateCode    :List of 1
##   ..$ : chr &quot;R_1-BAK-_-y05-1462422-O-1&quot;
##  $ Description    :List of 1
##   ..$ : chr &quot;Elephant &amp; Castle Station - Queen's Park Station (London)&quot;
##  $ RouteSectionRef:List of 1
##   ..$ : chr &quot;RS_1-BAK-_-y05-1462422-O-1&quot;
##  - attr(*, &quot;id&quot;)= chr &quot;R_1-BAK-_-y05-1462422-O-1&quot;
</code></pre>
<pre class="sourceCode r" id="cb18"><code class="sourceCode r"><div class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>JourneyPatternSections<span class="op">$</span>JourneyPatternSection[[<span class="dv">1</span>]])</div></code></pre>
<pre><code>## List of 4
##  $ From        :List of 3
##   ..$ Activity    :List of 1
##   .. ..$ : chr &quot;pickUp&quot;
##   ..$ StopPointRef:List of 1
##   .. ..$ : chr &quot;9400ZZLUEAC1&quot;
##   ..$ TimingStatus:List of 1
##   .. ..$ : chr &quot;PTP&quot;
##   ..- attr(*, &quot;SequenceNumber&quot;)= chr &quot;1&quot;
##  $ To          :List of 4
##   ..$ WaitTime    :List of 1
##   .. ..$ : chr &quot;PT1M&quot;
##   ..$ Activity    :List of 1
##   .. ..$ : chr &quot;pickUpAndSetDown&quot;
##   ..$ StopPointRef:List of 1
##   .. ..$ : chr &quot;9400ZZLULBN1&quot;
##   ..$ TimingStatus:List of 1
##   .. ..$ : chr &quot;PTP&quot;
##   ..- attr(*, &quot;SequenceNumber&quot;)= chr &quot;2&quot;
##  $ RouteLinkRef:List of 1
##   ..$ : chr &quot;RL_1-BAK-_-y05-1462422-O-1-1&quot;
##  $ RunTime     :List of 1
##   ..$ : chr &quot;PT1M&quot;
##  - attr(*, &quot;id&quot;)= chr &quot;JPL_1-BAK-_-y05-1462422-1-O-1-2&quot;
</code></pre>
<pre class="sourceCode r" id="cb20"><code class="sourceCode r"><div class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>Operators<span class="op">$</span>Operator)</div></code></pre>
<pre><code>## List of 4
##  $ OperatorCode         :List of 1
##   ..$ : chr &quot;LUL&quot;
##  $ OperatorShortName    :List of 1
##   ..$ : chr &quot;London Underground&quot;
##  $ OperatorNameOnLicence:List of 1
##   ..$ : chr &quot;London Underground&quot;
##  $ TradingName          :List of 1
##   ..$ : chr &quot;London Underground&quot;
##  - attr(*, &quot;id&quot;)= chr &quot;OId_LUL&quot;
</code></pre>
<pre class="sourceCode r" id="cb22"><code class="sourceCode r"><div class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>Services<span class="op">$</span>Service<span class="op">$</span>StandardService<span class="op">$</span>JourneyPattern)</div></code></pre>
<pre><code>## List of 4
##  $ Direction                :List of 1
##   ..$ : chr &quot;outbound&quot;
##  $ Operational              :List of 1
##   ..$ VehicleType:List of 2
##   .. ..$ VehicleTypeCode:List of 1
##   .. .. ..$ : chr &quot;UT&quot;
##   .. ..$ Description    :List of 1
##   .. .. ..$ : chr &quot;Underground Train&quot;
##  $ RouteRef                 :List of 1
##   ..$ : chr &quot;R_1-BAK-_-y05-1462422-O-1&quot;
##  $ JourneyPatternSectionRefs:List of 1
##   ..$ : chr &quot;JPS_1-BAK-_-y05-1462422-1-1-O&quot;
##  - attr(*, &quot;id&quot;)= chr &quot;JP_1-BAK-_-y05-1462422-1-O-1&quot;
</code></pre>
<pre class="sourceCode r" id="cb24"><code class="sourceCode r"><div class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">str</span>(xml_list<span class="op">$</span>VehicleJourneys<span class="op">$</span>VehicleJourney)</div></code></pre>
<pre><code>## List of 8
##  $ PrivateCode       :List of 1
##   ..$ : chr &quot;tfl-1-BAK-_-y05-1462422-1-TA&quot;
##  $ Operational       :List of 1
##   ..$ VehicleType:List of 2
##   .. ..$ VehicleTypeCode:List of 1
##   .. .. ..$ : chr &quot;UT&quot;
##   .. ..$ Description    :List of 1
##   .. .. ..$ : chr &quot;Underground Train&quot;
##  $ OperatingProfile  :List of 1
##   ..$ RegularDayType:List of 1
##   .. ..$ DaysOfWeek:List of 1
##   .. .. ..$ Sunday: list()
##  $ VehicleJourneyCode:List of 1
##   ..$ : chr &quot;VJ_1-BAK-_-y05-1462422-1-TA&quot;
##  $ ServiceRef        :List of 1
##   ..$ : chr &quot;1-BAK-_-y05-1462422&quot;
##  $ LineRef           :List of 1
##   ..$ : chr &quot;1-BAK-_-y05-1462422&quot;
##  $ JourneyPatternRef :List of 1
##   ..$ : chr &quot;JP_1-BAK-_-y05-1462422-1-O-1&quot;
##  $ DepartureTime     :List of 1
##   ..$ : chr &quot;11:29:00&quot;
</code></pre>
<pre class="sourceCode r" id="cb26"><code class="sourceCode r"><div class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># Show service data without the child node JourneyPatterns</span></div>
<div class="sourceLine" id="cb26-2" data-line-number="2">service &lt;-<span class="st"> </span>xml_list<span class="op">$</span>Services<span class="op">$</span>Service</div>
<div class="sourceLine" id="cb26-3" data-line-number="3">service<span class="op">$</span>StandardService &lt;-<span class="st"> </span><span class="ot">NULL</span></div>
<div class="sourceLine" id="cb26-4" data-line-number="4"><span class="kw">str</span>(service)</div></code></pre>
<pre><code>## List of 9
##  $ ServiceCode          :List of 1
##   ..$ : chr &quot;1-BAK-_-y05-1462422&quot;
##  $ PrivateCode          :List of 1
##   ..$ : chr &quot;1-BAK-_-y05-1462422&quot;
##  $ Lines                :List of 1
##   ..$ Line:List of 1
##   .. ..$ LineName:List of 1
##   .. .. ..$ : chr &quot;Bakerloo&quot;
##   .. ..- attr(*, &quot;id&quot;)= chr &quot;1-BAK-_-y05-1462422&quot;
##  $ OperatingPeriod      :List of 2
##   ..$ StartDate:List of 1
##   .. ..$ : chr &quot;2017-12-24&quot;
##   ..$ EndDate  :List of 1
##   .. ..$ : chr &quot;2017-12-24&quot;
##  $ OperatingProfile     :List of 2
##   ..$ RegularDayType      :List of 1
##   .. ..$ DaysOfWeek:List of 1
##   .. .. ..$ Sunday: list()
##   ..$ BankHolidayOperation:List of 2
##   .. ..$ DaysOfOperation   :List of 1
##   .. .. ..$ ChristmasDay: list()
##   .. ..$ DaysOfNonOperation: list()
##  $ RegisteredOperatorRef:List of 1
##   ..$ : chr &quot;OId_LUL&quot;
##  $ StopRequirements     :List of 1
##   ..$ NoNewStopsRequired: list()
##  $ Mode                 :List of 1
##   ..$ : chr &quot;underground&quot;
##  $ Description          :List of 1
##   ..$ : chr &quot;Elephant &amp; Castle - Waterloo - Harrow &amp; Wealdstone&quot;
</code></pre>
<p>Four of the tables contain particularly crucial information other than Reference fields and linking identifiers:</p>
<p><strong>Stop Points</strong></p>
<p>A tube station at which a given vehicle can stop.</p>
<ul>
<li><em>AtcoCode</em> is a unique identifier of the stop across the network. There is one for the inbound stops and a second identifier for the same stop going the other way. These group up into <em>Localities</em> (under the <em>Place</em> node)</li>
<li><em>CommonName</em> is the stop’s name</li>
<li><em>Location</em> contains its <em>Easting</em> and <em>Northing</em> coordinates</li>
</ul>
<p><strong>Journey Pattern Sections</strong></p>
<p>A trip link between two <strong>Stop Points</strong> (<em>From</em> and <em>To</em>) with a given <em>RunTime</em> and optional <em>WaitTime</em>. These combine to an overall <strong>Journey Pattern</strong>.</p>
<ul>
<li><em>From</em> and <em>To</em> fields show the trip links between two stations</li>
<li><em>WaitTime</em> is encoded as “PT1M” for example (assumed to be 1 minute of waiting) however is not applicable to every trip link (therefore the XML tag often disappears!)</li>
<li><em>RunTime</em> is also encoded and provides the time taken for a trip link</li>
</ul>
<p><strong>Services</strong></p>
<p>Provides information about the operating rhythm of the timetable</p>
<ul>
<li><em>LineName</em> though this is fairly obvious from the file name</li>
<li><em>Operating Period</em> as this tells us which period of time the timetable is actually active for. This particular timetable is only in effect on Christmas Eve.</li>
<li><em>Operating Profile</em> says for which day(s) of the week and bank holidays the timetable is and isn’t operational. Again, these tags will vary in their structure from document to document making these fields quite difficult to parse.</li>
</ul>
<p><strong>VehicleJourneys</strong></p>
<p>A tube vehicle’s <em>Journey Pattern</em> and the time of departure from its origin station.</p>
<ul>
<li><em>Operating Profile</em> again as some journeys may only apply to some of the days that a service spans</li>
<li><em>Departure Time</em> provides the train <em>origin</em> departure time. The difficult part is to now interpolate the departure time of <em>each station</em> along a journey using the RunTime and WaitTime in <strong>Journey Pattern Sections</strong>.</li>
</ul>
<p>It’s also worth noting that the <strong>StopPoints</strong> and <strong>NptgLocalities</strong> tables both contain duplicate information across every <strong>Service</strong> (XML file) for a given line and also contain duplicates <em>across</em> lines that share the same stops. Every other table has unique information per XML file because the routes, trip links, vehicles and journeys are all defined by Service. This would mean that the timetable for Christmas Day has a completely different set of trip links to that of Boxing Day (despite the trains physically running on exactly the same journey patterns) purely because there is a slight variation in the frequency of Vehicle Journeys between the dates. This clearly leads to a vast amount of duplicated information which can be easily cut down by a factor of up to 40x by extracting a subset of timetables of interest.</p>
<p>For a comprehensive description of the schema if not to appreciate the scale and complexity of the dataset, see the official DfT documentation <a href="http://naptan.dft.gov.uk/transxchange/schema/2.5/doc/TransXChangeSchemaGuide-2.5-v-59.pdf">here</a>. Page 63 in particular details how many of the elements discussed above will be joined in a PostgreSQL database later in this notebook.</p>
<h2 id="subsetting">Subsetting</h2>
<p>As seen in the previous section, the entire file shown is only relevant for one day of the year. By first filtering the files based on the Operating Period and Operating Profile, it’s possible to only read in the files that relate to a Monday or New Years Day or 17th January.</p>
<p>Here is a table containing every file along with its starting and ending operating period dates:</p>
<pre class="sourceCode r" id="cb28"><code class="sourceCode r"><div class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">library</span>(data.table)</div>
<div class="sourceLine" id="cb28-2" data-line-number="2">xpath.op_period &lt;-<span class="st"> &quot;.//txc:Services/txc:Service/txc:OperatingPeriod/*&quot;</span></div>
<div class="sourceLine" id="cb28-3" data-line-number="3"></div>
<div class="sourceLine" id="cb28-4" data-line-number="4">dates &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.files, <span class="cf">function</span>(xml_file) {</div>
<div class="sourceLine" id="cb28-5" data-line-number="5">  XML<span class="op">::</span><span class="kw">xmlParse</span>(xml_file) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb28-6" data-line-number="6"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xmlRoot</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb28-7" data-line-number="7"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xpathApply</span>(xpath.op_period, <span class="dt">namespaces =</span> namespace,</div>
<div class="sourceLine" id="cb28-8" data-line-number="8">                    <span class="dt">fun =</span> <span class="cf">function</span>(y) XML<span class="op">::</span><span class="kw">xmlValue</span>(y) <span class="op">%&gt;%</span><span class="st"> </span>as.Date)</div>
<div class="sourceLine" id="cb28-9" data-line-number="9">}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb28-10" data-line-number="10"><span class="st">  </span>{<span class="kw">data.table</span>(<span class="kw">names</span>(.), <span class="kw">rbindlist</span>(.))}</div>
<div class="sourceLine" id="cb28-11" data-line-number="11"><span class="kw">names</span>(dates) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;File&quot;</span>, <span class="st">&quot;StartDate&quot;</span>, <span class="st">&quot;EndDate&quot;</span>)</div>
<div class="sourceLine" id="cb28-12" data-line-number="12">dates[[<span class="st">&quot;File&quot;</span>]] &lt;-<span class="st"> </span><span class="kw">basename</span>(dates[[<span class="st">&quot;File&quot;</span>]])</div>
<div class="sourceLine" id="cb28-13" data-line-number="13"><span class="kw">head</span>(dates, <span class="dv">10</span>)</div></code></pre>
<pre><code>##                            File  StartDate    EndDate
##  1: tfl_1-BAK-_-y05-1462422.xml 2017-12-24 2017-12-24
##  2: tfl_1-BAK-_-y05-1462611.xml 2017-12-26 2017-12-26
##  3: tfl_1-BAK-_-y05-1462711.xml 2017-12-27 2017-12-27
##  4: tfl_1-BAK-_-y05-1463122.xml 2017-12-31 2017-12-31
##  5: tfl_1-BAK-_-y05-1463222.xml 2018-01-01 2018-01-01
##  6: tfl_1-BAK-_-y05-1465129.xml 2017-12-29 2017-12-29
##  7: tfl_1-BAK-_-y05-1465144.xml 2017-12-28 2017-12-28
##  8:  tfl_1-BAK-_-y05-430200.xml 2017-12-10 2018-12-23
##  9: tfl_1-CEN-_-y05-1315200.xml 2017-12-27 2017-12-28
## 10: tfl_1-CEN-_-y05-1492600.xml 2017-12-26 2017-12-26
</code></pre>
<p>The next step is to filter this dataframe based on whether a date of interest falls within the time interval of a file:</p>
<pre class="sourceCode r" id="cb30"><code class="sourceCode r"><div class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">library</span>(lubridate)</div>
<div class="sourceLine" id="cb30-2" data-line-number="2">timetable_date &lt;-<span class="st"> </span>lubridate<span class="op">::</span><span class="kw">today</span>()</div>
<div class="sourceLine" id="cb30-3" data-line-number="3">relevant_dates &lt;-<span class="st"> </span>dates <span class="op">%$%</span></div>
<div class="sourceLine" id="cb30-4" data-line-number="4"><span class="st">  </span><span class="co"># Test whether the timetable_date falls within StartDate to EndDate</span></div>
<div class="sourceLine" id="cb30-5" data-line-number="5"><span class="st">  </span><span class="kw">interval</span>(StartDate, EndDate) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb30-6" data-line-number="6"><span class="st">  </span>{timetable_date <span class="op">%within%</span><span class="st"> </span>.} <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb30-7" data-line-number="7"><span class="st">  </span><span class="co"># Subset dates to only these records</span></div>
<div class="sourceLine" id="cb30-8" data-line-number="8"><span class="st">  </span>dates[.]</div>
<div class="sourceLine" id="cb30-9" data-line-number="9"><span class="kw">head</span>(relevant_dates, <span class="dv">10</span>)</div></code></pre>
<pre><code>##                            File  StartDate    EndDate
##  1:  tfl_1-BAK-_-y05-430200.xml 2017-12-10 2018-12-23
##  2:  tfl_1-CEN-_-y05-690544.xml 2017-12-09 2018-12-23
##  3:  tfl_1-CIR-_-y05-465922.xml 2018-01-04 2018-12-23
##  4: tfl_1-DIS-_-y05-1490111.xml 2017-12-09 2018-12-23
##  5:  tfl_1-HAM-_-y05-465922.xml 2018-01-04 2018-12-23
##  6:  tfl_1-JUB-_-y05-520522.xml 2017-12-09 2018-12-23
##  7: tfl_1-MET-_-y05-3400500.xml 2017-12-09 2018-12-23
##  8:  tfl_1-NTN-_-y05-560800.xml 2017-12-09 2018-01-28
##  9:  tfl_1-PIC-_-y05-580800.xml 2017-12-09 2018-12-23
## 10:  tfl_1-VIC-_-y05-410833.xml 2017-12-09 2018-12-23
</code></pre>
<p>Now we’ve cut down the 84 files to roughly a quarter depending on the chosen <code>timetable_date</code>.</p>
<p>The other option (to filter based on the days of the week) is unfortunately even more convoluted. It should be as simply as filtering on the tags underneath Journey Operating Profile however here’s a list of the unique set of tags:</p>
<pre class="sourceCode r" id="cb32"><code class="sourceCode r"><div class="sourceLine" id="cb32-1" data-line-number="1">xpath.days_of_week &lt;-<span class="st"> &quot;.//txc:VehicleJourneys/txc:VehicleJourney/txc:OperatingProfile/txc:RegularDayType/txc:DaysOfWeek/*&quot;</span></div>
<div class="sourceLine" id="cb32-2" data-line-number="2">daysofweek &lt;-<span class="st"> </span><span class="kw">sapply</span>(data.files, <span class="cf">function</span>(xml_file) {</div>
<div class="sourceLine" id="cb32-3" data-line-number="3">  XML<span class="op">::</span><span class="kw">xmlParse</span>(xml_file) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb32-4" data-line-number="4"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xmlRoot</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb32-5" data-line-number="5"><span class="st">    </span>XML<span class="op">::</span><span class="kw">xpathApply</span>(xpath.days_of_week, <span class="dt">namespaces =</span> namespace, <span class="dt">fun =</span> XML<span class="op">::</span>xmlName)</div>
<div class="sourceLine" id="cb32-6" data-line-number="6">}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb32-7" data-line-number="7"><span class="st">  </span>unlist <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb32-8" data-line-number="8"><span class="st">  </span>unique</div>
<div class="sourceLine" id="cb32-9" data-line-number="9">daysofweek</div></code></pre>
<pre><code>## [1] &quot;Sunday&quot;         &quot;Wednesday&quot;      &quot;Friday&quot;         &quot;Thursday&quot;      
## [5] &quot;Monday&quot;         &quot;Saturday&quot;       &quot;MondayToFriday&quot; &quot;Tuesday&quot;       
## [9] &quot;Weekend&quot;
</code></pre>
<p>The “days of the week” also include values such as “MondayToFriday”, “Weekend” as well as “MondayToSaturday” and “MondayToSunday” under the Service Operating Profile. So we would need to create a mapping function between a given date and all of the possible “days of the week” it could fall under. As an example of how this can be accounted for, see <a href="DaysOfWeekGroups.html">this PostgreSQL table</a>.</p>
<h2 id="extraction">Extraction</h2>
<p>Now that we have a good understanding of what each file contains, we can attempt to extract the key information from one of them before generalising this process for all files. As we’ve already seen, the tree structure of these XML files is particularly complex thereby making one-size-fits-all functions such as <code>xmlToDataFrame</code> rather unhelpful. The level of control required is really only achievable by defining XPaths for the location of each piece of information we need and then looping through the document extracting every instance of each path. On the plus side, the files are well-formed and do not contain any errors which we may find in malformed web data.</p>
<p>Firstly, we’ll want to retrieve the parent XPaths for each of the nodes containing useful information. This is done simplest with a helper function <code>xml_get_paths</code> from the <a href="https://github.com/dantonnoriega/xmltools">xmltools</a> library.</p>
<!--
The empty code chunks represent code that lives in external files.
If you wish to execute the chunks interactively, run the corresponding
`read_chunk` (see previous chunk) to source the code and execute it with
`eval(parse(text=knitr:::knit_code$get()$extraction_setup))`
 -->

<pre class="sourceCode r" id="cb34"><code class="sourceCode r"><div class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># Get top level nodeset for first file</span></div>
<div class="sourceLine" id="cb34-2" data-line-number="2">doc &lt;-<span class="st"> </span>data.files[<span class="dv">1</span>] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-3" data-line-number="3"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">read_xml</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-4" data-line-number="4"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">xml_ns_strip</span>()</div>
<div class="sourceLine" id="cb34-5" data-line-number="5">nodeset &lt;-<span class="st"> </span>doc <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-6" data-line-number="6"><span class="st">  </span>xml2<span class="op">::</span><span class="kw">xml_children</span>()</div>
<div class="sourceLine" id="cb34-7" data-line-number="7"></div>
<div class="sourceLine" id="cb34-8" data-line-number="8"><span class="co"># Get the xpaths to parents of a terminal node</span></div>
<div class="sourceLine" id="cb34-9" data-line-number="9">terminal_xpaths &lt;-<span class="st"> </span>nodeset <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-10" data-line-number="10"><span class="st">  </span>xmltools<span class="op">::</span><span class="kw">xml_get_paths</span>(<span class="dt">only_terminal_parent =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-11" data-line-number="11"><span class="st">  </span><span class="co"># Filter to unique paths</span></div>
<div class="sourceLine" id="cb34-12" data-line-number="12"><span class="st">  </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb34-13" data-line-number="13"><span class="st">  </span><span class="kw">unique</span>()</div></code></pre>
<pre class="sourceCode r" id="cb35"><code class="sourceCode r"><div class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">head</span>(terminal_xpaths)</div></code></pre>
<pre><code>## [1] &quot;/TransXChange/NptgLocalities/AnnotatedNptgLocalityRef&quot;
## [2] &quot;/TransXChange/StopPoints/StopPoint&quot;                   
## [3] &quot;/TransXChange/StopPoints/StopPoint/Descriptor&quot;        
## [4] &quot;/TransXChange/StopPoints/StopPoint/Place&quot;             
## [5] &quot;/TransXChange/StopPoints/StopPoint/Place/Location&quot;    
## [6] &quot;/TransXChange/StopPoints/StopPoint/StopClassification&quot;
</code></pre>
<p>These are the XPaths to every possible terminal branch of the tree however a lot of the information isn’t particularly useful. For some of the tables, we’re only interested in specific sections. For example, the <em>Operational</em> tag isn’t interesting as it contains information about the vehicle which in this case will always be “Underground Train”. This is a similar story for the <em>Operator</em> which is always “London Underground”.</p>
<p>Therefore we can define a subset of the <code>terminal_xpaths</code> grouped by the table to which they each relate.</p>
<pre class="sourceCode r" id="cb37"><code class="sourceCode r"><div class="sourceLine" id="cb37-1" data-line-number="1">required_xpaths &lt;-<span class="st"> </span><span class="kw">list</span>(</div>
<div class="sourceLine" id="cb37-2" data-line-number="2">   <span class="dt">NptgLocalities =</span> <span class="dv">1</span></div>
<div class="sourceLine" id="cb37-3" data-line-number="3">  ,<span class="dt">StopPoints =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">5</span></div>
<div class="sourceLine" id="cb37-4" data-line-number="4">  ,<span class="dt">RouteLinks =</span> <span class="dv">8</span><span class="op">:</span><span class="dv">10</span></div>
<div class="sourceLine" id="cb37-5" data-line-number="5">  ,<span class="dt">Routes =</span> <span class="dv">11</span></div>
<div class="sourceLine" id="cb37-6" data-line-number="6">  ,<span class="dt">JourneyPatternTimingLinks =</span> <span class="dv">12</span><span class="op">:</span><span class="dv">14</span></div>
<div class="sourceLine" id="cb37-7" data-line-number="7">  ,<span class="dt">Services =</span> <span class="dv">16</span></div>
<div class="sourceLine" id="cb37-8" data-line-number="8">  ,<span class="dt">JourneyPatterns =</span> <span class="dv">24</span></div>
<div class="sourceLine" id="cb37-9" data-line-number="9">  ,<span class="dt">VehicleJourneys =</span> <span class="dv">26</span></div>
<div class="sourceLine" id="cb37-10" data-line-number="10">)</div></code></pre>
<pre class="sourceCode r" id="cb38"><code class="sourceCode r"><div class="sourceLine" id="cb38-1" data-line-number="1">terminal_xpaths[<span class="kw">unlist</span>(required_xpaths)]</div></code></pre>
<pre><code>##  [1] &quot;/TransXChange/NptgLocalities/AnnotatedNptgLocalityRef&quot;                                   
##  [2] &quot;/TransXChange/StopPoints/StopPoint&quot;                                                      
##  [3] &quot;/TransXChange/StopPoints/StopPoint/Descriptor&quot;                                           
##  [4] &quot;/TransXChange/StopPoints/StopPoint/Place&quot;                                                
##  [5] &quot;/TransXChange/StopPoints/StopPoint/Place/Location&quot;                                       
##  [6] &quot;/TransXChange/RouteSections/RouteSection/RouteLink&quot;                                      
##  [7] &quot;/TransXChange/RouteSections/RouteSection/RouteLink/From&quot;                                 
##  [8] &quot;/TransXChange/RouteSections/RouteSection/RouteLink/To&quot;                                   
##  [9] &quot;/TransXChange/Routes/Route&quot;                                                              
## [10] &quot;/TransXChange/JourneyPatternSections/JourneyPatternSection/JourneyPatternTimingLink&quot;     
## [11] &quot;/TransXChange/JourneyPatternSections/JourneyPatternSection/JourneyPatternTimingLink/From&quot;
## [12] &quot;/TransXChange/JourneyPatternSections/JourneyPatternSection/JourneyPatternTimingLink/To&quot;  
## [13] &quot;/TransXChange/Services/Service&quot;                                                          
## [14] &quot;/TransXChange/Services/Service/StandardService/JourneyPattern&quot;                           
## [15] &quot;/TransXChange/VehicleJourneys/VehicleJourney&quot;
</code></pre>
<p>This way, when it comes to extracting the data, all of the information found under the 8th, 9th and 10th paths of <code>terminal_xpaths</code> will be combined together under the <em>RouteSections</em> table (see elements 6-8 above).</p>
<p>Now it is just a matter of looping over this list, finding all of the matches for each path, extracting the underlying data and combining it into a single dataset for each of the tables.</p>
<pre class="sourceCode r" id="cb40"><code class="sourceCode r"><div class="sourceLine" id="cb40-1" data-line-number="1">build_tfl &lt;-<span class="st"> </span><span class="cf">function</span>(doc, terminal_xpaths, required_terminal_xpaths) {</div>
<div class="sourceLine" id="cb40-2" data-line-number="2">  purrr<span class="op">::</span><span class="kw">map</span>(required_terminal_xpaths, <span class="cf">function</span>(xpath_idxs) {</div>
<div class="sourceLine" id="cb40-3" data-line-number="3">    <span class="co"># Subset the needed paths</span></div>
<div class="sourceLine" id="cb40-4" data-line-number="4">    terminal_xpaths[xpath_idxs] <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb40-5" data-line-number="5"><span class="st">      </span><span class="co"># Find all matches of each path</span></div>
<div class="sourceLine" id="cb40-6" data-line-number="6"><span class="st">      </span><span class="kw">lapply</span>(xml2<span class="op">::</span>xml_find_all, <span class="dt">x =</span> doc) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb40-7" data-line-number="7"><span class="st">      </span><span class="co"># Extract underlying data</span></div>
<div class="sourceLine" id="cb40-8" data-line-number="8"><span class="st">      </span>purrr<span class="op">::</span><span class="kw">map</span>(xmltools<span class="op">::</span>xml_dig_df) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb40-9" data-line-number="9"><span class="st">      </span><span class="co"># Combine extracted data into one dataframe</span></div>
<div class="sourceLine" id="cb40-10" data-line-number="10"><span class="st">      </span>purrr<span class="op">::</span><span class="kw">map</span>(dplyr<span class="op">::</span>bind_rows) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb40-11" data-line-number="11"><span class="st">      </span>dplyr<span class="op">::</span><span class="kw">bind_cols</span>()</div>
<div class="sourceLine" id="cb40-12" data-line-number="12">  })</div>
<div class="sourceLine" id="cb40-13" data-line-number="13">}</div></code></pre>
<pre class="sourceCode r" id="cb41"><code class="sourceCode r"><div class="sourceLine" id="cb41-1" data-line-number="1">tfl &lt;-<span class="st"> </span><span class="kw">build_tfl</span>(doc, terminal_xpaths, required_xpaths)</div>
<div class="sourceLine" id="cb41-2" data-line-number="2"><span class="kw">str</span>(tfl, <span class="dv">1</span>)</div></code></pre>
<pre><code>## List of 8
##  $ NptgLocalities           :Classes 'tbl_df', 'tbl' and 'data.frame':   25 obs. of  2 variables:
##  $ StopPoints               :Classes 'tbl_df', 'tbl' and 'data.frame':   43 obs. of  7 variables:
##  $ RouteLinks               :Classes 'tbl_df', 'tbl' and 'data.frame':   195 obs. of  4 variables:
##  $ Routes                   :Classes 'tbl_df', 'tbl' and 'data.frame':   13 obs. of  3 variables:
##  $ JourneyPatternTimingLinks:Classes 'tbl_df', 'tbl' and 'data.frame':   794 obs. of  9 variables:
##  $ Services                 :Classes 'tbl_df', 'tbl' and 'data.frame':   1 obs. of  5 variables:
##  $ JourneyPatterns          :Classes 'tbl_df', 'tbl' and 'data.frame':   42 obs. of  3 variables:
##  $ VehicleJourneys          :Classes 'tbl_df', 'tbl' and 'data.frame':   501 obs. of  6 variables:
</code></pre>
<p>The result is the <code>tfl</code> list which contains the eight tables corresponding to the top-level nodes of this single XML file.</p>
<p>Due to the flexibility of XML and the TransXChange schema however, there’s still a lot missing…</p>
<ol>
<li>A number of important fields are found in the “id” <em>attribute</em> of certain tags, not in the tag’s text as we might expect.</li>
<li>The stop sequence numbers are contained in a “SequenceNumber” attribute</li>
<li>Some tables have a parent which contains join information. For example, the JourneyPatterns table is defined at the level of each Journey Pattern Section however we are missing the foreign key Journey Pattern ID as this is the parent node of each Section and therefore unable to be parsed with the same XPath.</li>
</ol>
<p>We can define a function <code>retrieve_additional_fields</code> which solves these three cases and call it after <code>build_tfl</code> for each document. Due to its length and complexity it is not shown here but can be found in the <a href="GetTablesFromXPaths.html">complete analysis file</a>.</p>
<pre class="sourceCode r" id="cb43"><code class="sourceCode r"><div class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">library</span>(magrittr)</div>
<div class="sourceLine" id="cb43-2" data-line-number="2">tfl <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">retrieve_additional_fields</span>(doc)</div></code></pre>
<p>We can put the whole extraction process together by calling <code>read_xml</code>, <code>build_tfl</code> and <code>retrieve_additional_fields</code> for each XML file:</p>
<pre class="sourceCode r" id="cb44"><code class="sourceCode r"><div class="sourceLine" id="cb44-1" data-line-number="1">extract_file &lt;-<span class="st"> </span><span class="cf">function</span>(file){</div>
<div class="sourceLine" id="cb44-2" data-line-number="2">  doc &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">read_xml</span>(file) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb44-3" data-line-number="3"><span class="st">    </span>xml2<span class="op">::</span><span class="kw">xml_ns_strip</span>()</div>
<div class="sourceLine" id="cb44-4" data-line-number="4">  </div>
<div class="sourceLine" id="cb44-5" data-line-number="5">  tfl &lt;-<span class="st"> </span><span class="kw">build_tfl</span>(doc, terminal_xpaths, required_xpaths)</div>
<div class="sourceLine" id="cb44-6" data-line-number="6">  tfl <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">retrieve_additional_fields</span>(doc)</div>
<div class="sourceLine" id="cb44-7" data-line-number="7">  </div>
<div class="sourceLine" id="cb44-8" data-line-number="8">  tfl</div>
<div class="sourceLine" id="cb44-9" data-line-number="9">}</div>
<div class="sourceLine" id="cb44-10" data-line-number="10"><span class="kw">str</span>(<span class="kw">extract_file</span>(data.files[<span class="dv">1</span>]), <span class="dv">1</span>)</div></code></pre>
<pre><code>## List of 8
##  $ NptgLocalities           :Classes 'tbl_df', 'tbl' and 'data.frame':   25 obs. of  2 variables:
##  $ StopPoints               :Classes 'tbl_df', 'tbl' and 'data.frame':   43 obs. of  7 variables:
##  $ RouteLinks               :Classes 'tbl_df', 'tbl' and 'data.frame':   195 obs. of  6 variables:
##   ..- attr(*, &quot;.internal.selfref&quot;)=&lt;externalptr&gt; 
##  $ Routes                   :Classes 'tbl_df', 'tbl' and 'data.frame':   13 obs. of  3 variables:
##  $ JourneyPatternTimingLinks:Classes 'tbl_df', 'tbl' and 'data.frame':   794 obs. of  13 variables:
##   ..- attr(*, &quot;.internal.selfref&quot;)=&lt;externalptr&gt; 
##  $ Services                 :Classes 'tbl_df', 'tbl' and 'data.frame':   1 obs. of  5 variables:
##  $ JourneyPatterns          :Classes 'tbl_df', 'tbl' and 'data.frame':   42 obs. of  4 variables:
##  $ VehicleJourneys          :Classes 'tbl_df', 'tbl' and 'data.frame':   501 obs. of  6 variables:
</code></pre>
<p>and then loop this function over the entire directory of files:</p>
<pre class="sourceCode r" id="cb46"><code class="sourceCode r"><div class="sourceLine" id="cb46-1" data-line-number="1">tfl_all &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(data.files, extract_file)</div></code></pre>
<p>Unfortunately, the bad news is this line of code takes a <strong>very</strong> long time to run so don’t execute it unless you plan on waiting all night. Literally…</p>
<p>To make this code more efficient it may benefit from a performance improvement by parsing the nested list structure using syntax such as <code>doc[[c(&quot;TransXChange&quot;, &quot;StopPoints&quot;, &quot;StopPoint&quot;)]]</code> however in its current form it is much slower when compared to the <code>lxml</code> Python library. The versatility of <code>lxml</code> is also better when it comes to traversing XML trees efficiently and extracting data in nested nodes, parent nodes and attributes as we require.</p>
<p>To cope with this problem, the dataset was instead scraped (with even more fields in more hard-to-reach places and about 500x faster) with <a href="XMLParsing.html">this file</a> which calls a custom-built <a href="TfLTimetable.html">TfL Class</a>.</p>
<h2 id="variable-creation">Variable Creation</h2>
<p>There are a few crucial variables which we’ll need to add along with correctly typecasting the current information for any further analysis. This is best done in R before handing over to a database. Due to the potential scale of the join operations (had we not already subsetted the dataset), additional variables which are calculations <em>across</em> tables will be left to the database stage. This is also to preserve the normalised nature of the tables within the database.</p>
<h3 id="latitude-and-longitude">Latitude and Longitude</h3>
<p>To make any use of the station locations, it’s necessary to convert the provided data to a more renowned coordinate system.</p>
<p>The <a href="http://naptan.dft.gov.uk/transxchange/technicalFaq.htm#PubCoords">TransXChange website</a> confirms that the “Easting” and “Northing” fields in the StopPoints dataset are British National Grid (BNG) coordinates whereas we require the more popular latitude and longitude.</p>
<p>This can be achieved with the R Geospatial Data Abstraction Library which is able to convert between the two coordinate projections via the <a href="http://proj4.org/">PROJ.4</a> library:</p>
<pre class="sourceCode r" id="cb47"><code class="sourceCode r"><div class="sourceLine" id="cb47-1" data-line-number="1"><span class="kw">library</span>(rgdal)</div></code></pre>
<pre><code>## Warning: package 'rgdal' was built under R version 3.4.2

## Loading required package: sp

## rgdal: version: 1.2-15, (SVN revision 691)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.1.3, released 2017/20/01
##  Path to GDAL shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/gdal
##  GDAL binary built with GEOS: FALSE 
##  Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]
##  Path to PROJ.4 shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/proj
##  Linking to sp version: 1.2-5
</code></pre>
<pre class="sourceCode r" id="cb49"><code class="sourceCode r"><div class="sourceLine" id="cb49-1" data-line-number="1">modify_StopPoints &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb49-2" data-line-number="2">  <span class="co"># Define proj4 coordinate systems</span></div>
<div class="sourceLine" id="cb49-3" data-line-number="3">  bng &lt;-<span class="st"> &quot;+init=epsg:27700&quot;</span></div>
<div class="sourceLine" id="cb49-4" data-line-number="4">  latlon &lt;-<span class="st"> &quot;+proj=longlat +datum=WGS84&quot;</span></div>
<div class="sourceLine" id="cb49-5" data-line-number="5"></div>
<div class="sourceLine" id="cb49-6" data-line-number="6">  <span class="co"># Create spatial object using BNG coordinates</span></div>
<div class="sourceLine" id="cb49-7" data-line-number="7">  coord.bng &lt;-</div>
<div class="sourceLine" id="cb49-8" data-line-number="8"><span class="st">    </span><span class="kw">with</span>(df,</div>
<div class="sourceLine" id="cb49-9" data-line-number="9">         <span class="kw">SpatialPointsDataFrame</span>(</div>
<div class="sourceLine" id="cb49-10" data-line-number="10">           <span class="kw">cbind</span>(Place_Location_Easting, Place_Location_Northing) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb49-11" data-line-number="11"><span class="st">             </span><span class="kw">as.integer</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="dv">2</span>),</div>
<div class="sourceLine" id="cb49-12" data-line-number="12">           <span class="dt">data =</span> <span class="kw">tibble</span>(AtcoCode,</div>
<div class="sourceLine" id="cb49-13" data-line-number="13">                         Descriptor_CommonName,</div>
<div class="sourceLine" id="cb49-14" data-line-number="14">                         Place_NptgLocalityRef),</div>
<div class="sourceLine" id="cb49-15" data-line-number="15">           <span class="dt">proj4string =</span> <span class="kw">CRS</span>(bng)))</div>
<div class="sourceLine" id="cb49-16" data-line-number="16"></div>
<div class="sourceLine" id="cb49-17" data-line-number="17">  <span class="co"># Cast as latlon coordinates</span></div>
<div class="sourceLine" id="cb49-18" data-line-number="18">  coord.latlon &lt;-<span class="st"> </span><span class="kw">spTransform</span>(coord.bng, <span class="kw">CRS</span>(latlon))</div>
<div class="sourceLine" id="cb49-19" data-line-number="19"></div>
<div class="sourceLine" id="cb49-20" data-line-number="20">  <span class="co"># Replace dataframe</span></div>
<div class="sourceLine" id="cb49-21" data-line-number="21">  df &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(coord.latlon)</div>
<div class="sourceLine" id="cb49-22" data-line-number="22">  <span class="kw">names</span>(df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AtcoCode&quot;</span>,<span class="st">&quot;CommonName&quot;</span>,<span class="st">&quot;NptgLocalityRef&quot;</span>,<span class="st">&quot;Longitude&quot;</span>,<span class="st">&quot;Latitude&quot;</span>)</div>
<div class="sourceLine" id="cb49-23" data-line-number="23">  df</div>
<div class="sourceLine" id="cb49-24" data-line-number="24">}</div></code></pre>
<h3 id="journeytime-and-departuremins">JourneyTime and DepartureMins</h3>
<p>Perhaps the most significant variable is the RunTime of each journey section as it supposedly tells us the travel time between two StopPoints.</p>
<pre class="sourceCode r" id="cb50"><code class="sourceCode r"><div class="sourceLine" id="cb50-1" data-line-number="1"><span class="kw">table</span>(tfl<span class="op">$</span>JourneyPatternTimingLinks<span class="op">$</span>RunTime)</div></code></pre>
<pre><code>## 
## PT0S PT1M PT2M PT3M PT4M PT7M 
##   24  397  330   41    1    1
</code></pre>
<p>Unfortunately this frequency table shows that the duration is presented as a text field where it’s assumed the “M” indicates the RunTime is rounded to the nearest minute. Judging by the “0S” field, this would also suggest that a number of links take zero seconds! Clearly the duration has been rounded to the nearest minute however it also turns out that every instance of zero RunTime has at least 1 minute of WaitTime at the next station.</p>
<pre class="sourceCode r" id="cb52"><code class="sourceCode r"><div class="sourceLine" id="cb52-1" data-line-number="1"><span class="co"># Check that there aren't records with both no WaitTime and zero RunTime</span></div>
<div class="sourceLine" id="cb52-2" data-line-number="2">tfl<span class="op">$</span>JourneyPatternTimingLinks <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb52-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(WaitTime) <span class="op">&amp;&amp;</span><span class="st"> </span>RunTime <span class="op">==</span><span class="st"> &quot;PT0S&quot;</span>) <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb52-4" data-line-number="4"><span class="st">  </span>nrow <span class="op">==</span><span class="st"> </span><span class="dv">0</span></div></code></pre>
<pre><code>## [1] TRUE
</code></pre>
<p>Therefore, we can convert the RunTime and WaitTime to integer variables by extracting the third character from every observation and build a new variable “JourneyTime” which takes into account the total RunTime and WaitTime which we now know will always be at least 1 minute:</p>
<pre class="sourceCode r" id="cb54"><code class="sourceCode r"><div class="sourceLine" id="cb54-1" data-line-number="1">modify_JourneyPatternTimingLinks &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb54-2" data-line-number="2">  <span class="kw">within</span>(df, {</div>
<div class="sourceLine" id="cb54-3" data-line-number="3">    From_SequenceNumber <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb54-4" data-line-number="4">    To_SequenceNumber <span class="op">%&lt;&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb54-5" data-line-number="5">    <span class="co"># Extract timings from RunTime and WaitTime to create JourneyTime</span></div>
<div class="sourceLine" id="cb54-6" data-line-number="6">    RunTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">substr</span>(<span class="dv">3</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb54-7" data-line-number="7">    WaitTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">substr</span>(<span class="dv">3</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.integer</div>
<div class="sourceLine" id="cb54-8" data-line-number="8">    JourneyTime &lt;-<span class="st"> </span>RunTime <span class="op">+</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(WaitTime), <span class="dv">0</span>, WaitTime)</div>
<div class="sourceLine" id="cb54-9" data-line-number="9">  })</div>
<div class="sourceLine" id="cb54-10" data-line-number="10">}</div></code></pre>
<p>The other most important field is the departure times of every train from their origin station, DepartureTime, which is currently stored as text.</p>
<pre class="sourceCode r" id="cb55"><code class="sourceCode r"><div class="sourceLine" id="cb55-1" data-line-number="1"><span class="kw">head</span>(tfl<span class="op">$</span>VehicleJourneys<span class="op">$</span>DepartureTime)</div></code></pre>
<pre><code>## [1] &quot;11:29:00&quot; &quot;12:39:00&quot; &quot;19:16:00&quot; &quot;20:28:00&quot; &quot;09:57:00&quot; &quot;12:56:00&quot;
</code></pre>
<p>So it looks like this variable is a time stamp which is also rounded to the nearest minute.</p>
<p>Since we are now dealing solely in minutes on a day-by-day basis, it would make the most sense to cast this DepartureTime field as “the number of minutes since midnight”. This makes it less human-readable however addition of DepartureTime with JourneyTime is now very straightforward and doesn’t rely on date-time typecasting or datediff functions. That said, in the event that we’re using a database that handles date-times well, it doesn’t hurt to correctly cast DepartureTime and keep it in the data frame separately.</p>
<pre class="sourceCode r" id="cb57"><code class="sourceCode r"><div class="sourceLine" id="cb57-1" data-line-number="1">modify_VehicleJourneys &lt;-<span class="st"> </span><span class="cf">function</span>(df){</div>
<div class="sourceLine" id="cb57-2" data-line-number="2">  <span class="kw">within</span>(df, {</div>
<div class="sourceLine" id="cb57-3" data-line-number="3">    DepartureTime <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">as.POSIXct</span>(<span class="dt">format =</span> <span class="st">&quot;%T&quot;</span>)</div>
<div class="sourceLine" id="cb57-4" data-line-number="4">    <span class="co"># Extract number of minutes since midnight from DepartureTime</span></div>
<div class="sourceLine" id="cb57-5" data-line-number="5">    DepartureMins &lt;-<span class="st"> </span>DepartureTime <span class="op">%&gt;%</span></div>
<div class="sourceLine" id="cb57-6" data-line-number="6"><span class="st">      </span>{lubridate<span class="op">::</span><span class="kw">minute</span>(.) <span class="op">+</span><span class="st"> </span><span class="dv">60</span> <span class="op">*</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">hour</span>(.)}</div>
<div class="sourceLine" id="cb57-7" data-line-number="7">  })</div>
<div class="sourceLine" id="cb57-8" data-line-number="8">}</div></code></pre>
<h1 id="normalisation-and-relational-databases">Normalisation and Relational Databases</h1>
<p>As found in the previous section, the dataset is provided in 3rd normal form already making it very easy to simply push the tables as-is to a database.</p>
<h2 id="dbms-setup">DBMS Setup</h2>
<p>Due to the information given to us, the queries to be computed in-database are quite advanced and require running cumulative calculations and row offsets by group which are only available in an advanced DBMS and not SQLite or MySQL.</p>
<p>For this reason, we’ll use an open-source database PostgreSQL for its <a href="http://www.postgresqltutorial.com/postgresql-window-function/">windowing functions</a> though other proprietary databases such as Oracle or Microsoft also provide this functionality. Thanks to <a href="https://www.docker.com/what-docker">Docker</a> containers, provisioning a clean lightweight Postgres database on your local machine is one line of code without any additional setup other than downloading Docker itself.</p>
<pre class="sourceCode bash" id="cb58"><code class="sourceCode bash"><div class="sourceLine" id="cb58-1" data-line-number="1"><span class="ex">docker</span> run --name postgres_london_tube -p 5432:5432 -d -e POSTGRES_PASSWORD=mysecretpassword postgres:alpine</div></code></pre>
<p><em>The alpine image is about 1/10th the size of the official postgres container as it uses a significantly smaller distribution of Linux with fewer of PostgreSQL’s auxilliary features.</em></p>
<p>Test that the server is running and the connection works by setting up a development database for the project:</p>
<pre class="sourceCode r" id="cb59"><code class="sourceCode r"><div class="sourceLine" id="cb59-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(drv, <span class="dt">host =</span> host, <span class="dt">user =</span> user, <span class="dt">password =</span> password,</div>
<div class="sourceLine" id="cb59-2" data-line-number="2">                 <span class="dt">dbname =</span> <span class="st">&quot;postgres&quot;</span>)</div>
<div class="sourceLine" id="cb59-3" data-line-number="3"><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;CREATE DATABASE londontube_r;&quot;</span>)</div></code></pre>
<pre><code>## &lt;PostgreSQLResult&gt;
</code></pre>
<pre class="sourceCode r" id="cb61"><code class="sourceCode r"><div class="sourceLine" id="cb61-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<pre><code>## [1] TRUE
</code></pre>
<pre class="sourceCode r" id="cb63"><code class="sourceCode r"><div class="sourceLine" id="cb63-1" data-line-number="1">get_con &lt;-<span class="st"> </span><span class="cf">function</span>() {</div>
<div class="sourceLine" id="cb63-2" data-line-number="2">  <span class="kw">dbConnect</span>(drv,</div>
<div class="sourceLine" id="cb63-3" data-line-number="3">            <span class="dt">host =</span> host, <span class="dt">user =</span> user, <span class="dt">password =</span> password,</div>
<div class="sourceLine" id="cb63-4" data-line-number="4">            <span class="dt">dbname =</span> <span class="st">&quot;londontube_r&quot;</span>)</div>
<div class="sourceLine" id="cb63-5" data-line-number="5">}</div></code></pre>
<h2 id="build-database">Build database</h2>
<p>We can write a function that loops over all eight tables sequentially adding them to the database whilst dropping any existing tables.</p>
<p>First define the primary keys of the tables:</p>
<pre class="sourceCode r" id="cb64"><code class="sourceCode r"><div class="sourceLine" id="cb64-1" data-line-number="1">primarykeys &lt;-<span class="st"> </span><span class="kw">list</span>(</div>
<div class="sourceLine" id="cb64-2" data-line-number="2">  <span class="dt">NptgLocalities =</span> <span class="st">'&quot;NptgLocalityRef&quot;'</span>,</div>
<div class="sourceLine" id="cb64-3" data-line-number="3">  <span class="dt">StopPoints =</span> <span class="st">'&quot;AtcoCode&quot;'</span>,</div>
<div class="sourceLine" id="cb64-4" data-line-number="4">  <span class="dt">RouteLinks =</span> <span class="st">'&quot;RouteLinkID&quot;'</span>,</div>
<div class="sourceLine" id="cb64-5" data-line-number="5">  <span class="dt">Routes =</span> <span class="st">'&quot;PrivateCode&quot;'</span>,</div>
<div class="sourceLine" id="cb64-6" data-line-number="6">  <span class="dt">JourneyPatternTimingLinks =</span> <span class="st">'&quot;JourneyPatternTimingLinkID&quot;'</span>,</div>
<div class="sourceLine" id="cb64-7" data-line-number="7">  <span class="dt">Services =</span> <span class="st">'&quot;ServiceCode&quot;'</span>,</div>
<div class="sourceLine" id="cb64-8" data-line-number="8">  <span class="dt">JourneyPatterns =</span> <span class="st">'&quot;JourneyPatternID&quot;'</span>,</div>
<div class="sourceLine" id="cb64-9" data-line-number="9">  <span class="dt">VehicleJourneys =</span> <span class="st">'&quot;VehicleJourneyCode&quot;'</span></div>
<div class="sourceLine" id="cb64-10" data-line-number="10">)</div></code></pre>
<p>and upload the data:</p>
<pre class="sourceCode r" id="cb65"><code class="sourceCode r"><div class="sourceLine" id="cb65-1" data-line-number="1">create_tables &lt;-<span class="st"> </span><span class="cf">function</span>(tablename, tabledata, primary_key_cols, con){</div>
<div class="sourceLine" id="cb65-2" data-line-number="2">  <span class="co"># Insert data</span></div>
<div class="sourceLine" id="cb65-3" data-line-number="3">  <span class="kw">dbWriteTable</span>(con, tablename, tabledata, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</div>
<div class="sourceLine" id="cb65-4" data-line-number="4">  </div>
<div class="sourceLine" id="cb65-5" data-line-number="5">  <span class="co"># Add Primary Keys</span></div>
<div class="sourceLine" id="cb65-6" data-line-number="6">  query &lt;-<span class="st"> </span><span class="kw">sprintf</span>(</div>
<div class="sourceLine" id="cb65-7" data-line-number="7">    <span class="st">&quot;ALTER TABLE %1$s</span></div>
<div class="sourceLine" id="cb65-8" data-line-number="8"><span class="st">    ADD PRIMARY KEY (%2$s);&quot;</span>,</div>
<div class="sourceLine" id="cb65-9" data-line-number="9">    tablename, <span class="co"># Current table name</span></div>
<div class="sourceLine" id="cb65-10" data-line-number="10">    <span class="kw">paste</span>(primary_key_cols, <span class="dt">collapse =</span> <span class="st">&quot;, &quot;</span>) <span class="co"># PK columns</span></div>
<div class="sourceLine" id="cb65-11" data-line-number="11">  )</div>
<div class="sourceLine" id="cb65-12" data-line-number="12">  </div>
<div class="sourceLine" id="cb65-13" data-line-number="13">  <span class="co"># Run queries</span></div>
<div class="sourceLine" id="cb65-14" data-line-number="14">  <span class="kw">dbExecute</span>(con, query)</div>
<div class="sourceLine" id="cb65-15" data-line-number="15">}</div>
<div class="sourceLine" id="cb65-16" data-line-number="16"></div>
<div class="sourceLine" id="cb65-17" data-line-number="17"><span class="co"># Build database with the same tablenames as input data</span></div>
<div class="sourceLine" id="cb65-18" data-line-number="18">con &lt;-<span class="st"> </span><span class="kw">get_con</span>()</div>
<div class="sourceLine" id="cb65-19" data-line-number="19">tablenames &lt;-<span class="st"> </span><span class="kw">tolower</span>(<span class="kw">names</span>(tfl))</div>
<div class="sourceLine" id="cb65-20" data-line-number="20">table_creation &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">pmap</span>(<span class="kw">list</span>(tablenames, tfl, primarykeys),</div>
<div class="sourceLine" id="cb65-21" data-line-number="21">                              create_tables, con)</div>
<div class="sourceLine" id="cb65-22" data-line-number="22"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<pre><code>## [1] TRUE
</code></pre>
<p>Finally we can check that the tables were loaded successfully:</p>
<pre class="sourceCode r" id="cb67"><code class="sourceCode r"><div class="sourceLine" id="cb67-1" data-line-number="1">con &lt;-<span class="st"> </span><span class="kw">get_con</span>()</div>
<div class="sourceLine" id="cb67-2" data-line-number="2"><span class="kw">dbListTables</span>(con)</div></code></pre>
<pre><code>## [1] &quot;nptglocalities&quot;            &quot;stoppoints&quot;               
## [3] &quot;routelinks&quot;                &quot;routes&quot;                   
## [5] &quot;journeypatterntiminglinks&quot; &quot;services&quot;                 
## [7] &quot;journeypatterns&quot;           &quot;vehiclejourneys&quot;
</code></pre>
<pre class="sourceCode r" id="cb69"><code class="sourceCode r"><div class="sourceLine" id="cb69-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</div></code></pre>
<pre><code>## [1] TRUE
</code></pre>
<h2 id="joining-tables">Joining Tables</h2>
<p>To build out the timetable, we’ve seen that there are two crucial tables:</p>
<ul>
<li><strong>VehicleJourneys</strong> which lists each train and its time of departure from the journey origin</li>
<li><strong>JourneyPatternTimingLinks</strong> contains the sequence of stops for each possible journey and the journey time of each link</li>
</ul>
<p>What we’re after is a network-wide departures board which has the time of departure from each <em>station</em> and not just the train origin. Therefore, it’s a matter of expanding out every Vehicle Journey by the number of sequences in the Journey Pattern to calculate each Vehicle Link departure.</p>
<p>The departures board table is achieved as follows:</p>
<ol>
<li>Join <strong>VehicleJourneys</strong> to <strong>JourneyPatternTimingLinks</strong> via <strong>JourneyPatterns</strong></li>
<li>Calculate <em>ArrivalMins_Link</em> (arrival time of each train into each station) as the origin departure time (<em>DepartureMins</em>) plus the cumulative sum of <em>JourneyTime</em> ordered by link sequence for each vehicle</li>
<li>Calculate <em>DepartureMins_Link</em> as the preceding link’s arrival time. For the first link, it’s the origin departure time.</li>
</ol>
<p>For analysis later on, we also want to flag whether the link is the last trip in the vehicle’s journey. This just involves checking whether the link sequence is the largest value for that vehicle.</p>
<p>The table-valued function <code>departureboard</code> is as follows:</p>
<pre class="sourceCode sql" id="cb71"><code class="sourceCode sql"><div class="sourceLine" id="cb71-1" data-line-number="1"><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> departureboard(<span class="kw">IN</span> _timetable_date text)</div>
<div class="sourceLine" id="cb71-2" data-line-number="2">  RETURNS <span class="kw">TABLE</span> (</div>
<div class="sourceLine" id="cb71-3" data-line-number="3">    <span class="ot">&quot;VehicleJourneyCode&quot;</span> text,</div>
<div class="sourceLine" id="cb71-4" data-line-number="4">    <span class="ot">&quot;Line&quot;</span> text,</div>
<div class="sourceLine" id="cb71-5" data-line-number="5">    <span class="ot">&quot;From_VehicleSequenceNumber&quot;</span> <span class="dt">integer</span>,</div>
<div class="sourceLine" id="cb71-6" data-line-number="6">    <span class="ot">&quot;From_StopPointRef&quot;</span> text,</div>
<div class="sourceLine" id="cb71-7" data-line-number="7">    <span class="ot">&quot;From_StopPointName&quot;</span> text,</div>
<div class="sourceLine" id="cb71-8" data-line-number="8">    <span class="ot">&quot;From_Longitude&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-9" data-line-number="9">    <span class="ot">&quot;From_Latitude&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-10" data-line-number="10">    <span class="ot">&quot;To_VehicleSequenceNumber&quot;</span> <span class="dt">integer</span>,</div>
<div class="sourceLine" id="cb71-11" data-line-number="11">    <span class="ot">&quot;To_StopPointRef&quot;</span> text,</div>
<div class="sourceLine" id="cb71-12" data-line-number="12">    <span class="ot">&quot;To_StopPointName&quot;</span> text,</div>
<div class="sourceLine" id="cb71-13" data-line-number="13">    <span class="ot">&quot;To_Longitude&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-14" data-line-number="14">    <span class="ot">&quot;To_Latitude&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-15" data-line-number="15">    <span class="ot">&quot;JourneyTime&quot;</span>   <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-16" data-line-number="16">    <span class="ot">&quot;DepartureMins_Link&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-17" data-line-number="17">    <span class="ot">&quot;ArrivalMins_Link&quot;</span> <span class="dt">double</span> <span class="dt">precision</span>,</div>
<div class="sourceLine" id="cb71-18" data-line-number="18">    <span class="ot">&quot;Flag_LastStop&quot;</span> <span class="dt">boolean</span></div>
<div class="sourceLine" id="cb71-19" data-line-number="19">  )</div>
<div class="sourceLine" id="cb71-20" data-line-number="20"></div>
<div class="sourceLine" id="cb71-21" data-line-number="21">  <span class="kw">AS</span></div>
<div class="sourceLine" id="cb71-22" data-line-number="22"></div>
<div class="sourceLine" id="cb71-23" data-line-number="23">  $BODY$</div>
<div class="sourceLine" id="cb71-24" data-line-number="24"></div>
<div class="sourceLine" id="cb71-25" data-line-number="25">  <span class="kw">SELECT</span></div>
<div class="sourceLine" id="cb71-26" data-line-number="26"></div>
<div class="sourceLine" id="cb71-27" data-line-number="27">     <span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb71-28" data-line-number="28">     <span class="co">-- Extract three-letter line abbreviation</span></div>
<div class="sourceLine" id="cb71-29" data-line-number="29">    ,SUBSTRING(<span class="ot">&quot;LineRef&quot;</span> <span class="kw">FROM</span> <span class="dv">3</span> <span class="kw">FOR</span> <span class="dv">3</span>) <span class="ot">&quot;Line&quot;</span></div>
<div class="sourceLine" id="cb71-30" data-line-number="30">    ,<span class="fu">CAST</span>(<span class="ot">&quot;From_VehicleSequenceNumber&quot;</span> <span class="kw">as</span> <span class="dt">int</span>) <span class="ot">&quot;From_VehicleSequenceNumber&quot;</span></div>
<div class="sourceLine" id="cb71-31" data-line-number="31">    ,<span class="ot">&quot;From_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-32" data-line-number="32">    ,<span class="ot">&quot;From_StopPointName&quot;</span></div>
<div class="sourceLine" id="cb71-33" data-line-number="33">    ,<span class="ot">&quot;From_Longitude&quot;</span></div>
<div class="sourceLine" id="cb71-34" data-line-number="34">    ,<span class="ot">&quot;From_Latitude&quot;</span></div>
<div class="sourceLine" id="cb71-35" data-line-number="35">    <span class="co">-- Re-create SequenceNumber for each vehicle</span></div>
<div class="sourceLine" id="cb71-36" data-line-number="36">    ,<span class="fu">CAST</span>(<span class="ot">&quot;From_VehicleSequenceNumber&quot;</span> + <span class="dv">1</span> <span class="kw">as</span> <span class="dt">int</span>) <span class="ot">&quot;To_VehicleSequenceNumber&quot;</span></div>
<div class="sourceLine" id="cb71-37" data-line-number="37">    ,<span class="ot">&quot;To_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-38" data-line-number="38">    ,<span class="ot">&quot;To_StopPointName&quot;</span></div>
<div class="sourceLine" id="cb71-39" data-line-number="39">    ,<span class="ot">&quot;To_Longitude&quot;</span></div>
<div class="sourceLine" id="cb71-40" data-line-number="40">    ,<span class="ot">&quot;To_Latitude&quot;</span></div>
<div class="sourceLine" id="cb71-41" data-line-number="41">    ,<span class="ot">&quot;JourneyTime&quot;</span></div>
<div class="sourceLine" id="cb71-42" data-line-number="42">    <span class="co">-- DepartureMins_Link is the ArrivalMins_Link of the previous row</span></div>
<div class="sourceLine" id="cb71-43" data-line-number="43">    <span class="co">-- partitioned by vehicle and ordered by stop sequence</span></div>
<div class="sourceLine" id="cb71-44" data-line-number="44">    ,<span class="fu">LAG</span>(<span class="ot">&quot;ArrivalMins_Link&quot;</span>, <span class="dv">1</span>, <span class="ot">&quot;DepartureMins&quot;</span>) <span class="kw">OVER</span></div>
<div class="sourceLine" id="cb71-45" data-line-number="45">      (<span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="ot">&quot;VehicleJourneyCode&quot;</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="ot">&quot;From_SequenceNumber&quot;</span>)</div>
<div class="sourceLine" id="cb71-46" data-line-number="46">      <span class="kw">AS</span> <span class="ot">&quot;DepartureMins_Link&quot;</span></div>
<div class="sourceLine" id="cb71-47" data-line-number="47">    ,<span class="ot">&quot;ArrivalMins_Link&quot;</span></div>
<div class="sourceLine" id="cb71-48" data-line-number="48">    ,<span class="ot">&quot;Flag_LastStop&quot;</span></div>
<div class="sourceLine" id="cb71-49" data-line-number="49"></div>
<div class="sourceLine" id="cb71-50" data-line-number="50">  <span class="kw">FROM</span> (</div>
<div class="sourceLine" id="cb71-51" data-line-number="51"></div>
<div class="sourceLine" id="cb71-52" data-line-number="52">    <span class="kw">SELECT</span></div>
<div class="sourceLine" id="cb71-53" data-line-number="53"></div>
<div class="sourceLine" id="cb71-54" data-line-number="54">       v.<span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb71-55" data-line-number="55">      ,v.<span class="ot">&quot;LineRef&quot;</span></div>
<div class="sourceLine" id="cb71-56" data-line-number="56">      ,v.<span class="ot">&quot;DepartureMins&quot;</span></div>
<div class="sourceLine" id="cb71-57" data-line-number="57"></div>
<div class="sourceLine" id="cb71-58" data-line-number="58">      ,j.<span class="ot">&quot;From_SequenceNumber&quot;</span></div>
<div class="sourceLine" id="cb71-59" data-line-number="59">      <span class="co">-- Re-create SequenceNumber for each vehicle by ranking the current SequenceNumber</span></div>
<div class="sourceLine" id="cb71-60" data-line-number="60">      <span class="co">-- within a vehicle partition</span></div>
<div class="sourceLine" id="cb71-61" data-line-number="61">      ,<span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> v.<span class="ot">&quot;VehicleJourneyCode&quot;</span> <span class="kw">ORDER</span> <span class="kw">BY</span> j.<span class="ot">&quot;From_SequenceNumber&quot;</span>)</div>
<div class="sourceLine" id="cb71-62" data-line-number="62">        <span class="ot">&quot;From_VehicleSequenceNumber&quot;</span></div>
<div class="sourceLine" id="cb71-63" data-line-number="63">      ,j.<span class="ot">&quot;From_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-64" data-line-number="64">      ,p1.<span class="ot">&quot;CommonName&quot;</span> <span class="ot">&quot;From_StopPointName&quot;</span></div>
<div class="sourceLine" id="cb71-65" data-line-number="65">      ,p1.<span class="ot">&quot;Longitude&quot;</span> <span class="ot">&quot;From_Longitude&quot;</span></div>
<div class="sourceLine" id="cb71-66" data-line-number="66">      ,p1.<span class="ot">&quot;Latitude&quot;</span> <span class="ot">&quot;From_Latitude&quot;</span></div>
<div class="sourceLine" id="cb71-67" data-line-number="67">      ,j.<span class="ot">&quot;To_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-68" data-line-number="68">      ,p2.<span class="ot">&quot;CommonName&quot;</span> <span class="ot">&quot;To_StopPointName&quot;</span></div>
<div class="sourceLine" id="cb71-69" data-line-number="69">      ,p2.<span class="ot">&quot;Longitude&quot;</span> <span class="ot">&quot;To_Longitude&quot;</span></div>
<div class="sourceLine" id="cb71-70" data-line-number="70">      ,p2.<span class="ot">&quot;Latitude&quot;</span> <span class="ot">&quot;To_Latitude&quot;</span></div>
<div class="sourceLine" id="cb71-71" data-line-number="71"></div>
<div class="sourceLine" id="cb71-72" data-line-number="72">      ,j.<span class="ot">&quot;JourneyTime&quot;</span></div>
<div class="sourceLine" id="cb71-73" data-line-number="73">      <span class="co">-- Create ArrivalMins_Link as DepartureMins plus the cumulative JourneyTime</span></div>
<div class="sourceLine" id="cb71-74" data-line-number="74">      ,v.<span class="ot">&quot;DepartureMins&quot;</span> + <span class="fu">SUM</span>(j.<span class="ot">&quot;JourneyTime&quot;</span>) <span class="kw">OVER</span></div>
<div class="sourceLine" id="cb71-75" data-line-number="75">        (<span class="kw">PARTITION</span> <span class="kw">BY</span> v.<span class="ot">&quot;VehicleJourneyCode&quot;</span> <span class="kw">ORDER</span> <span class="kw">BY</span> j.<span class="ot">&quot;From_SequenceNumber&quot;</span>)</div>
<div class="sourceLine" id="cb71-76" data-line-number="76">        <span class="kw">AS</span> <span class="ot">&quot;ArrivalMins_Link&quot;</span></div>
<div class="sourceLine" id="cb71-77" data-line-number="77">      <span class="co">-- Flag whether the current To_SequenceNumber is the greatest within a</span></div>
<div class="sourceLine" id="cb71-78" data-line-number="78">      <span class="co">-- Vehicle partition</span></div>
<div class="sourceLine" id="cb71-79" data-line-number="79">      ,j.<span class="ot">&quot;To_SequenceNumber&quot;</span> = <span class="fu">MAX</span>(j.<span class="ot">&quot;To_SequenceNumber&quot;</span>) <span class="kw">OVER</span></div>
<div class="sourceLine" id="cb71-80" data-line-number="80">        (<span class="kw">PARTITION</span> <span class="kw">BY</span> v.<span class="ot">&quot;VehicleJourneyCode&quot;</span>) <span class="kw">AS</span> <span class="ot">&quot;Flag_LastStop&quot;</span></div>
<div class="sourceLine" id="cb71-81" data-line-number="81"></div>
<div class="sourceLine" id="cb71-82" data-line-number="82">    <span class="co">/* Journey and Timing Link Tables */</span></div>
<div class="sourceLine" id="cb71-83" data-line-number="83">    <span class="kw">FROM</span> <span class="ot">&quot;VehicleJourneys&quot;</span> v</div>
<div class="sourceLine" id="cb71-84" data-line-number="84">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;JourneyPatterns&quot;</span> s</div>
<div class="sourceLine" id="cb71-85" data-line-number="85">      <span class="kw">ON</span> s.<span class="ot">&quot;JourneyPattern&quot;</span> = v.<span class="ot">&quot;JourneyPatternRef&quot;</span></div>
<div class="sourceLine" id="cb71-86" data-line-number="86">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;JourneyPatternTimingLinks&quot;</span> j</div>
<div class="sourceLine" id="cb71-87" data-line-number="87">      <span class="kw">ON</span> j.<span class="ot">&quot;JourneyPatternSections&quot;</span> = s.<span class="ot">&quot;JourneyPatternSectionRefs&quot;</span></div>
<div class="sourceLine" id="cb71-88" data-line-number="88"></div>
<div class="sourceLine" id="cb71-89" data-line-number="89">    <span class="co">/* Stop Names */</span></div>
<div class="sourceLine" id="cb71-90" data-line-number="90">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;StopPoints&quot;</span> p1</div>
<div class="sourceLine" id="cb71-91" data-line-number="91">      <span class="kw">ON</span> p1.<span class="ot">&quot;AtcoCode&quot;</span> = j.<span class="ot">&quot;From_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-92" data-line-number="92">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;StopPoints&quot;</span> p2</div>
<div class="sourceLine" id="cb71-93" data-line-number="93">      <span class="kw">ON</span> p2.<span class="ot">&quot;AtcoCode&quot;</span> = j.<span class="ot">&quot;To_StopPointRef&quot;</span></div>
<div class="sourceLine" id="cb71-94" data-line-number="94"></div>
<div class="sourceLine" id="cb71-95" data-line-number="95">    <span class="co">/* Operating Periods and Operating Profiles */</span></div>
<div class="sourceLine" id="cb71-96" data-line-number="96">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;Services_RegularDayType_DaysOfWeek&quot;</span> d1</div>
<div class="sourceLine" id="cb71-97" data-line-number="97">      <span class="kw">ON</span> d1.<span class="ot">&quot;Services&quot;</span> = v.<span class="ot">&quot;ServiceRef&quot;</span></div>
<div class="sourceLine" id="cb71-98" data-line-number="98">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;VehicleJourneys_RegularDayType_DaysOfWeek&quot;</span> d2</div>
<div class="sourceLine" id="cb71-99" data-line-number="99">      <span class="kw">ON</span> d2.<span class="ot">&quot;VehicleJourneys&quot;</span> = v.<span class="ot">&quot;VehicleJourneyCode&quot;</span></div>
<div class="sourceLine" id="cb71-100" data-line-number="100">    <span class="kw">LEFT</span> <span class="kw">JOIN</span> <span class="ot">&quot;Services&quot;</span> b</div>
<div class="sourceLine" id="cb71-101" data-line-number="101">      <span class="kw">ON</span> b.<span class="ot">&quot;ServiceCode&quot;</span> = v.<span class="ot">&quot;ServiceRef&quot;</span></div>
<div class="sourceLine" id="cb71-102" data-line-number="102"></div>
<div class="sourceLine" id="cb71-103" data-line-number="103">    <span class="kw">WHERE</span></div>
<div class="sourceLine" id="cb71-104" data-line-number="104">    <span class="co">-- Filter to timetables that have services and journeys on _timetable_date day of the week</span></div>
<div class="sourceLine" id="cb71-105" data-line-number="105">          d1.<span class="ot">&quot;DaysOfWeek&quot;</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="ot">&quot;DayGroup&quot;</span> <span class="kw">FROM</span> DaysOfWeek_Groups</div>
<div class="sourceLine" id="cb71-106" data-line-number="106">                              <span class="kw">WHERE</span> <span class="ot">&quot;DayIndex&quot;</span> = DATE_PART(<span class="st">'ISODOW'</span>,</div>
<div class="sourceLine" id="cb71-107" data-line-number="107">                                                           <span class="fu">CAST</span>(_timetable_date <span class="kw">AS</span> <span class="dt">date</span>)))</div>
<div class="sourceLine" id="cb71-108" data-line-number="108">      <span class="kw">AND</span> d2.<span class="ot">&quot;DaysOfWeek&quot;</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> <span class="ot">&quot;DayGroup&quot;</span> <span class="kw">FROM</span> DaysOfWeek_Groups</div>
<div class="sourceLine" id="cb71-109" data-line-number="109">                              <span class="kw">WHERE</span> <span class="ot">&quot;DayIndex&quot;</span> = DATE_PART(<span class="st">'ISODOW'</span>,</div>
<div class="sourceLine" id="cb71-110" data-line-number="110">                                                           <span class="fu">CAST</span>(_timetable_date <span class="kw">AS</span> <span class="dt">date</span>)))</div>
<div class="sourceLine" id="cb71-111" data-line-number="111"></div>
<div class="sourceLine" id="cb71-112" data-line-number="112">    <span class="co">-- Filter to timetables that are operating on _timetable_date</span></div>
<div class="sourceLine" id="cb71-113" data-line-number="113">      <span class="kw">AND</span> <span class="fu">CAST</span>(_timetable_date <span class="kw">AS</span> <span class="dt">date</span>) <span class="kw">BETWEEN</span> b.<span class="ot">&quot;OpPeriod_StartDate&quot;</span> <span class="kw">AND</span> b.<span class="ot">&quot;OpPeriod_EndDate&quot;</span></div>
<div class="sourceLine" id="cb71-114" data-line-number="114"></div>
<div class="sourceLine" id="cb71-115" data-line-number="115">  ) arrival_calc</div>
<div class="sourceLine" id="cb71-116" data-line-number="116"></div>
<div class="sourceLine" id="cb71-117" data-line-number="117">  $BODY$ LANGUAGE sql;</div></code></pre>
<p>As you can imagine, when pushing every timetable to the database this table blows out to 6.63M rows. As discussed earlier, the vast majority of it is redundant information. Entire XML files are duplicated for special calendar days such as Bank Holidays, New Years, Christmas etc. hence the need to sample the data.</p>
<p>If using the Python methodology of scraping the dataset for all files, this sampling process discussed earlier now occurs as part of the Departures Board query <code>WHERE</code> clause.</p>
<p>Essentially we just filter on the Operating Profile of the Services and Vehicle Journeys to be one day of the week and filter the Operating Periods to be those that contain a given date. Now, by passing in the date “Wednesday 20th Dec 2017” for example the table size has reduced to 244K rows.</p>
<p>As we now have the dataset in a cleaned and use-able format, this completes the Managing Data notebook. We will now go on to visualise this newly created Departure Board table in <a href="VisualisingData.html">Part Two</a></p>

</body>
</html>
